---
title: "Survey extents"
author: "Denise-Colombano"
date: "11/5/2021"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning= FALSE, message = FALSE)
```

The purpose of this script is to evaluate the spatial and temporal overlap of 
the different surveys used in the SEM.

Inventory datasets:

Annual SEM:
- Fish: FMWT, Bay Study, DJFMP Beach seine (ISS)
- Zoop/nutrients: EMP
- Benthic: EMP Benthic
- Flows: Dayflow

Monthly SEM:
- Fish:
- Zoop/ nutrients:
- Benthic: 
- Flows: Dayflow


# Load libraries
```{r}
# tidy data
library(tidyverse)

library(DT)
library(leaflet)
library(sf)
library(janitor)
```

# Fish surveys

Query the CDFW Fall Midwater Trawl and Bay Study data sets from the LTMRdata package.

## FMWT
```{r}
library(LTMRdata)

Surveys <- LTMRdata::fish(sources=c("FMWT", "Baystudy"),
             species=NULL,
             convert_lengths=TRUE,
             size_cutoff=40,
             zero_fill = TRUE,
             remove_unknown_lengths = TRUE,
             univariate = FALSE,
             quiet = FALSE)
Surveys

Surveys$Month <- lubridate::month(Surveys$Date)
Surveys$Year <- lubridate::year(Surveys$Date)
str(Surveys)

detach(package:LTMRdata, unload=TRUE) # detach because it conflicts with discretewq
```


Assess sampling density across space and time
```{r}
SamplingDensity <- Surveys %>%
  select(Source, Method, Station, Latitude, Longitude, Year, Month) %>% 
  distinct(Source, Method, Station, Latitude, Longitude, Year, Month) %>% 
  mutate(Sampling=1)

summary(SamplingDensity)

# Bay Study
Baystudy <- SamplingDensity %>% 
  filter(Source=="Bay Study") %>% 
  group_by(Station, Longitude, Latitude, Year) %>% 
  summarize(Sampling=sum(Sampling)/24) # 2 gears x 12 months = 24 sampling points per year
Baystudy

ggplot(Baystudy, aes(Longitude, Latitude))+
  geom_point(aes(color=Station, size=Sampling), pch=21)+
  theme_bw()+
  facet_wrap(Year~.)+
  scale_color_viridis_d()

# FMWT
Fallmwt <- SamplingDensity %>% 
  filter(Source=="FMWT") %>% 
  group_by(Station, Longitude, Latitude, Year) %>% 
  summarize(Sampling=sum(Sampling)) 
Fallmwt

ggplot(Fallmwt, aes(Longitude, Latitude))+
  geom_point(aes(color=Station, size=Sampling), pch=21)+
  theme_bw()+
  facet_wrap(Year~.)+
  scale_color_viridis_d()
```


## DJFMP Seine

Load data using Sam's LTMRdata package and show map of beach seine stations. Code from BM "fish_DJFMP.Rmd"
```{r, echo = FALSE, message=FALSE, warning=FALSE}

library(ggmap)

DJFMP_Silverside_seine <-LTMRdata::fish(sources="DJFMP", 
                                        species="Menidia audens", 
                                        size_cutoff=NULL,remove_unknown_lengths=FALSE) %>%
                                  filter(Method=="Beach seine")

#Map
DJFMP_Coords<-DJFMP_Silverside_seine %>% group_by(Station) %>% 
  summarise(Latitude=mean(Latitude),Longitude=mean(Longitude))
DJFMP_Coords<-DJFMP_Coords[complete.cases(DJFMP_Coords), ]

buffer <- 0.05
coordDict = list(
  'minLat' = min(DJFMP_Coords$Latitude) - buffer,
  'maxLat' = max(DJFMP_Coords$Latitude) + buffer,
  'minLon' = min(DJFMP_Coords$Longitude) - buffer,
  'maxLon' = max(DJFMP_Coords$Longitude) + buffer
)

map_obj <- get_stamenmap(
  bbox = c(left = coordDict[['minLon']], bottom = coordDict[['minLat']], right = coordDict[['maxLon']], top = coordDict[['maxLat']]),
  zoom = 10,
  maptype = 'terrain'
)

# plot the map
map <- ggmap(map_obj) +
  theme_void() +
  geom_point(data = DJFMP_Coords, aes(x = Longitude, y = Latitude), shape = 21, fill = 'red', size = 3) +
  geom_text(data = DJFMP_Coords, aes(label = Station, x = Longitude, y = Latitude), vjust = 0, hjust = 0, size=2.5)

map

```



# Zoop surveys

Query the EMP data from the Zooper package. Borrow code from "zoop.Rmd" by S.B.
```{r}
library(zooper)
```


Load core stations
```{r, message=FALSE}
download.file("https://portal.edirepository.org/nis/dataviewer?packageid=edi.522.7&entityid=71dd301f30a2bc2e40f5da573dde9f97", destfile = file.path(tempdir(), "zoop_station_lookup.csv"))

zoop_stations<-read_csv(file.path(tempdir(), "zoop_station_lookup.csv"))%>%
  filter(Core%in%c(1, 2))
```

Load zoop data
```{r}
zoop_data<-Zoopsynther(Data_type="Community", Sources="EMP", Time_consistency = TRUE)%>%
  filter(Station%in%zoop_stations$StationNZ)%>%
  mutate(Month=lubridate::month(Date))

detach(package:zooper, unload=TRUE)
```

Remove stations that aren't continuous
```{r}
zoop_data_continuous<-filter(zoop_data, !Station%in%c("NZEZ6", "NZEZ2", "NZD16", "NZD06", "NZ080", "NZ042"))

# Make sure the right number of stations was removed
length(setdiff(unique(zoop_data$Station), unique(zoop_data_continuous$Station)))==6

str(zoop_data_continuous)

zoop_data_continuous2 <- zoop_data_continuous %>% 
  distinct(Station)
```


"Final" stations for annual model (12)
```{r}
zoop_annual <- read_csv("data/stations/stations_zoop_annual.csv")
```


"Final" stations for monthly model (15)
```{r}
zoop_month <- read_csv("data/stations/stations_zoop_month.csv")
```


Assess sampling density across space and time
```{r}
zoop_surveys <- zoop_data_continuous %>% 
  select(Month, Year, Station, Longitude, Latitude) %>% 
  distinct(Month, Year, Station, Longitude, Latitude) %>% 
  mutate(Sampling=1)

zoop_emp <- zoop_surveys %>% 
  group_by(Station, Year, Longitude, Latitude) %>% 
  summarize(Sampling=sum(Sampling))

ggplot(zoop_emp, aes(Longitude, Latitude))+
  geom_point(aes(color=Station, size=Sampling), pch=21)+
  theme_bw()+
  facet_wrap(Year~.)+
  scale_color_viridis_d()
```

## Fish + Zoop
Layer them on top of each other
```{r}
# map for each year
ggplot()+
  geom_point(data=Fallmwt, aes(Longitude, Latitude), pch=21, color="gray50")+
  geom_point(data=Baystudy, aes(Longitude, Latitude), pch=21, color="orange")+
  geom_point(data=zoop_emp, aes(Longitude, Latitude), pch=4, color="slateblue")+  
  theme_bw()+
  facet_wrap(Year~.)+
  labs(subtitle="Spatial overlap - annual")

# map for all years
ggplot()+
  geom_point(data=Fallmwt, aes(Longitude, Latitude), pch=21, color="gray50", size=3)+
  geom_point(data=Baystudy, aes(Longitude, Latitude), pch=21, color="orange", size=3)+
  geom_point(data=zoop_emp, aes(Longitude, Latitude), pch=3, color="slateblue", size=3)+  
  theme_bw()+
  labs(subtitle="Spatial overlap - overall")
```


# Water quality

Same stations as EMP zooplankton that are already plotted.
Data lives here.
```{r}
# library(discretewq)
# wq_stations <- wq(Sources = "EMP")
# wq_stations <- pivot_longer(wq_stations, 
#                             cols = c(Temperature, Chlorophyll:TKN, Salinity), 
#                             names_to = 'Analyte', values_to = 'Value')
# detach(package:discretewq, unload=TRUE)
```


# Benthic 

Code borrowed from the benthic.Rmd by JC
```{r, message=FALSE}
ben <- read_csv("data_raw/DWR Benthic raw count data 1975-2020 2021_10_01.csv")  %>% 
  mutate(StationClean =  gsub("-[A-Z]","",StationCode)) %>% 
  mutate(mon = lubridate::ym(paste0(Year, Month, sep = "-"))) %>% 
  group_by(StationClean) %>% 
  mutate(Latitude = mean(Latitude, na.rm = T), 
         Longitude = mean(Longitude, na.rm = T)) %>% 
  ungroup()
```

```{r}
sites_mon <- ben  %>% 
  distinct(StationClean, Latitude, Longitude, mon) 

sites <- ben %>% 
  group_by(StationClean, Latitude, Longitude) %>% 
  summarise(n_months = length(unique(mon)), .groups  =  "drop") %>% 
  st_as_sf(coords = c('Longitude','Latitude'), crs = 4326,  remove = FALSE)
```

## Sites that were sampled each month


```{r, echo=F}
ggplot(sites_mon, aes(x = mon, y = StationClean), size = 3) +
  geom_point() +
  theme_classic()
```


## Table of site information

```{r, echo = FALSE}
datatable(as.data.frame(sites))
```

## Core Stations

```{r}
core <- c("P8",
          "MD10",
          "D8",
          "D7",
          "D6",
          "D41",
          "D4",
          "D28A",
          "D26",
          "C3",
          "C10")

core_data <-  sites_mon %>% 
  filter(StationClean %in% core)

sites_core <- sites %>% 
  filter(StationClean %in% core)
```


```{r, echo=F}
ggplot(core_data, aes(x = mon, y = StationClean), size = 3) +
  geom_point() +
  theme_classic()
```


## Pesticide data
```{r}
# library(dataRetrieval)
# ?dataRetrieval
```


# Regional designations

Code from deltamapr documentation. https://github.com/InteragencyEcologicalProgram/deltamapr#regions
```{r}
library(deltamapr)
library(ggplot2)
library(sf)

# query region
deltamapr::R_EDSM_Regions_1617P1
st_crs(R_EDSM_Regions_1617P1) <- 26910
ggplot(R_EDSM_Regions_1617P1)+
   geom_sf(aes(fill=Region))+
   theme_bw()

deltamapr::R_EDSM_Subregions_Mahardja
st_crs(R_EDSM_Subregions_Mahardja) <- 26910
ggplot(R_EDSM_Subregions_Mahardja)+
   geom_sf(aes(fill=Region))+
   theme_bw()


polygon%>%st_transform(crs=4326)%>%st_coordinates()
```

# Annual map
```{r, message = FALSE, echo = FALSE}
#If you want to use predefined palettes in the RColorBrewer package:
# Call RColorBrewer::display.brewer.all() to see all possible palettes
pal <- colorFactor(
  palette = 'viridis',
  domain = R_EDSM_Subregions_Mahardja$SubRegion
)


leaflet(sites) %>% 
  addTiles() %>% 
  addPolygons(data=R_EDSM_Subregions_Mahardja %>% st_transform(crs=4326),
              color = ~pal(SubRegion),
              label = ~SubRegion) %>% 
  addCircleMarkers(data = Fallmwt,
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = 2, 
                         fillColor = "gray",
                         fillOpacity = 0.5,
                         weight = 0.1,
                         label = ~Station) %>% 
  addCircleMarkers(data = Baystudy,
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = 2,
                         fillColor = "yellow",
                         fillOpacity = 0.5,
                         weight = 0.1,
                         color = "black",
                         label = ~Station) %>% 
  addCircleMarkers(data = zoop_emp,
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = 2,
                        fillColor = "blue",
                         fillOpacity = 1,
                         weight = 0.1,
                         color = "black",
                         label = ~Station) %>% 
  addCircleMarkers(data = sites_core,
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = 3, 
                         fillColor = "red",
                         fillOpacity = 1,
                         weight = 0.1,
                         color = "black",
                         label = ~StationClean)
```







---
title: "Survey extents"
author: "Denise-Colombano"
date: "11/5/2021"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning= FALSE, message = FALSE)
```

The purpose of this script is to evaluate the spatial and temporal overlap of 
the different surveys used in the SEM.

TASK LIST:

1) Inventory datasets:

Annual SEM:
- Fish: FMWT, Bay Study, DJFMP Beach seine (ISS)
- Zoop/nutrients: EMP
- Benthic: EMP Benthic
- Flows: Dayflow

Monthly SEM:
- Fish: FMWT, Bay Study, DJFMP Beach seine (ISS)
- Zoop/ nutrients: EMP
- Benthic: EMP Benthic
- Flows: Dayflow


2) Plot them:
- Plot all monthly stations on one map
- Evaluate overlap with region designations
- Create new region map, based on station overlap
- Export polygon layer and station designations
- Use new polygon layer to get dayflow estimates


# Load libraries
```{r}
# tidy data
library(tidyverse)
library(ggthemes)
library(patchwork)

library(DT)
library(leaflet)
library(sf)
library(janitor)

#devtools::install_github("yutannihilation/ggsflabel")
library(ggsflabel)

#devtools::install_github("tomroh/leaflegend")
library(leaflegend)
```


# Fish surveys

## Bay Study
```{r}
Bay_annual <- read_csv("data/stations/stations_fish_BayStudy_annual.csv") %>% 
  mutate(Category="Fish")
Bay_annual$Station <- as.character(Bay_annual$Station)
View(Bay_annual)
```

## Fall Midwater Trawl
```{r}
FMWT_annual <- read_csv("data/stations/stations_fish_FMWT_annual.csv")%>% 
  mutate(Category="Fish")
FMWT_annual$Station <- as.character(FMWT_annual$Station)
View(FMWT_annual)
```

## Delta Juvenile Fish Monitoring Program
```{r}
seine_annual <- read_csv("data/stations/stations_fish_DJFMP_annual.csv")%>% 
  mutate(Category="Fish")
seine_annual$Station <- as.character(seine_annual$Station)
View(seine_annual)
```

```{r}
seine_month <- read_csv("data/stations/stations_fish_DJFMP_monthly.csv")%>% 
  mutate(Category="Fish")
seine_month$Station <- as.character(seine_month$Station)
View(seine_month)
```


# Zoop surveys

```{r}
zoop_annual <- read_csv("data/stations/stations_zoop_annual.csv")%>% 
  mutate(Category="Zoop/WQ", Survey="EMP Zooplankton and water quality")
View(zoop_annual)
```

```{r}
zoop_month <- read_csv("data/stations/stations_zoop_month.csv")%>% 
  mutate(Category="Zoop/WQ", Survey="EMP Zooplankton and water quality")
View(zoop_month)
```


# Water quality

Same stations as EMP zooplankton.


# Nutrient surveys
```{r}
nutrients_annual <- read_csv("data/stations/stations_nutrients_annual.csv")%>% 
  mutate(Category="Nutrients", Survey="EMP Nutrients")
View(nutrients_annual)
```

```{r}
nutrients_month <- read_csv("data/stations/stations_nutrients_monthly.csv")%>% 
  mutate(Category="Nutrients", Survey="EMP Nutrients")
View(nutrients_month)
```


# Benthic surveys
```{r}
benthic_month <- read_csv("data/stations/stations_benthic.csv")%>% 
  mutate(Category="Clams", Survey="EMP Benthic")
View(benthic_month)
```


# Pesticide data
TBD.
```{r}
# library(dataRetrieval)
# ?dataRetrieval
```


# Stitch together
```{r}
station_list <- bind_rows(Bay_annual, FMWT_annual, seine_month, zoop_month, benthic_month, nutrients_month)
station_list$Survey <- factor(station_list$Survey)
station_list$Station <- factor(station_list$Station)
View(station_list)

station_list %>% write_csv("data/stations/station_list_all_surveys.csv")
```



# Regional designations

Code from deltamapr documentation. https://github.com/InteragencyEcologicalProgram/deltamapr#regions
```{r}
library(deltamapr)
library(ggplot2)
library(sf)

# query region
deltamapr::R_EDSM_Regions_1617P1
st_crs(R_EDSM_Regions_1617P1) <- 26910
ggplot(R_EDSM_Regions_1617P1)+
   geom_sf(aes(fill=Region))+
   theme_bw()

deltamapr::R_EDSM_Subregions_Mahardja
st_crs(R_EDSM_Subregions_Mahardja) <- 26910

ggplot(R_EDSM_Subregions_Mahardja)+
  geom_sf(aes(fill=Region))+
  geom_sf_label(aes(label=SubRegion), size=2) +
  theme_bw()+
  ggthemes::scale_fill_colorblind()

polygon%>%st_transform(crs=4326)%>%st_coordinates()
```


Make maps

# Region, subregions, labels
```{r}
#work in progress help
# Subregions_transform <- st_transform(R_EDSM_Subregions_Mahardja, crs=st_crs(26910)) %>%
#   st_coordinates() %>%
#   as_tibble()
# 
# ggplot()+
#   geom_sf(data=Subregions_transform, aes(fill=SubRegion)) #+
#   ggsflabel::geom_sf_label_repel(aes(label=SubRegion),
#                                  size=2, color="gray40", force = 100, nudge_x = -1, seed = 10,
#                                  max.overlaps = getOption("ggrepel.max.overlaps",
#                                                           default = 40))+
#   scale_fill_viridis_d()
```




# Monthly map: leaflet
```{r, message = FALSE, echo = FALSE}
#If you want to use predefined palettes in the RColorBrewer package:
# Call RColorBrewer::display.brewer.all() to see all possible palettes

pal <- colorFactor(
  palette = 'grey',
  domain = R_EDSM_Subregions_Mahardja$SubRegion
)

# plot with separate dataframes
leaflet() %>% 
  addTiles() %>% 
  addPolygons(data=R_EDSM_Subregions_Mahardja %>% 
              st_transform(crs=4326),
              color = ~pal(SubRegion),
              label = ~SubRegion) %>% 
    addCircleMarkers(data = seine_month,
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = 4,
                         fillColor = "black",
                         fillOpacity = 0.5,
                         weight = 0.1,
                         label = ~Station) %>%
  addCircleMarkers(data = FMWT_annual, # same as month
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = 4,
                         fillColor = "green",
                         fillOpacity = 0.5,
                         weight = 0.1,
                         label = ~Station) %>%
  addCircleMarkers(data = Bay_annual, # same as month
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = 4,
                         fillColor = "yellow",
                         fillOpacity = 0.5,
                         weight = 0.1,
                         color = "black",
                         label = ~Station) %>%
  addCircleMarkers(data = zoop_month,
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = 4,
                        fillColor = "blue",
                         fillOpacity = 1,
                         weight = 0.1,
                         color = "black",
                         label = ~Station) %>% 
  addCircleMarkers(data = nutrients_month, 
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = 4,
                        fillColor = "purple",
                         fillOpacity = 1,
                         weight = 0.1,
                         color = "black",
                         label = ~Station) %>%
  addCircleMarkers(data = benthic_month,  
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = 4,
                         fillColor = "red",
                         fillOpacity = 1,
                         weight = 0.1,
                         color = "black",
                         label = ~Station) 




# plot with single dataframe for simplicity

pal2 <- colorFactor(
  palette = c("green", "purple", "pink", "black", "white", "yellow"),
  domain = station_list$Survey
)

leaflet() %>% 
  addTiles() %>% 
  addPolygons(data=R_EDSM_Subregions_Mahardja %>% 
              st_transform(crs=4326),
              color = ~pal(SubRegion),
              label = ~SubRegion,
              group = "polygons",
              weight=2,
              opacity=1) %>% 
    addCircleMarkers(data = station_list,  
                         lat = ~Latitude,
                         lng = ~Longitude,
                          color = ~pal2(Survey),
                          radius = 2,
                          weight = 2,
                          opacity= 1,
                          label = ~Station) %>% 
  # help here-- need the legend to show one label for each survey type
    addLegend(data=station_list,
                          "bottomleft",
                          #values = ~Survey,
                          colors = ~pal2(Survey),
                          title = "Survey stations",
                          labels = ~Survey,
                          opacity = 1,
                          group = "circles", 
                          labFormat = labelFormat(style = list(
                  "font-family" = "serif",
                  "font-size" = "8px"))) %>%
    addLayersControl(baseGroups = c("polygons"))
```


# Extract subregions of interest and combine
```{r}
Regions <- R_EDSM_Subregions_Mahardja %>%
  filter(SubRegion != "South Bay") %>% 
  filter(SubRegion != "San Francisco Bay") %>% 
  filter(SubRegion != "Upper Napa River") %>% 
    filter(SubRegion != "Upper Yolo Bypass") %>% 
    filter(SubRegion != "Cache Slough and Lindsey Slough") %>% 
    filter(SubRegion !="Liberty Island") %>% 
    filter(SubRegion != "Upper Sacramento River Ship Channel") %>% 
    filter(SubRegion != "Grant Line Canal and Old River") %>% 
    filter(SubRegion != "Disappointment Slough") %>% 
    filter(SubRegion != "Rock Slough and Discovery Bay") %>% 
    filter(SubRegion != "Steamboat and Miner Slough") %>% 
    filter(SubRegion != "Franks Tract")
View(Regions)
```

```{r}
# plot with single dataframe for simplicity

pal2 <- colorFactor(
  palette = c("green", "purple", "pink", "black", "white", "yellow"),
  domain = station_list$Survey
)

leaflet() %>% 
  addTiles() %>% 
  addPolygons(data=Regions %>% 
              st_transform(crs=4326),
              color = ~pal(SubRegion),
              label = ~SubRegion,
              group = "polygons",
              weight=2,
              opacity=1) %>% 
    addCircleMarkers(data = station_list,  
                         lat = ~Latitude,
                         lng = ~Longitude,
                          color = ~pal2(Survey),
                          radius = 2,
                          weight = 2,
                          opacity= 1,
                          label = ~Station) %>% 
  # help here-- need the legend to show one label for each survey type
    addLegend(data=station_list,
                          "bottomleft",
                          #values = ~Survey,
                          colors = ~pal2(Survey),
                          title = "Survey stations",
                          labels = ~Survey,
                          opacity = 1,
                          group = "circles", 
                          labFormat = labelFormat(style = list(
                  "font-family" = "serif",
                  "font-size" = "8px"))) %>%
    addLayersControl(baseGroups = c("polygons"))
```

## stations as simple features
```{r}
station_tbl <- tibble(lat=station_list$Latitude, lon=station_list$Longitude)

station_points <- st_as_sf(station_list, coords = c("Longitude", "Latitude"), 
                 crs= 4326, agr = "constant") %>% 
                  st_transform(crs=4326)
View(station_points)
```



## regions as simple features
URL: https://r-spatial.github.io/sf/reference/geos_combine.html

Pilot code for joining regions with st_union function
Compare different regional designations for San Pablo Bay as an example
```{r}
# san pablo bay only
sanpablo1 <- Regions %>% 
  filter(SubRegion == "San Pablo Bay") %>% 
  mutate(Designation = "San Pablo Bay")
  
sanpablo1_union <- st_union(sanpablo1$geometry, by_feature= FALSE)
plot(sanpablo1_union)

# san pablo bay, lower napa, and carquinez strait
sanpablo2 <- Regions %>% 
  filter(SubRegion == "San Pablo Bay" |
        SubRegion == "Lower Napa River" |
        SubRegion == "Carquinez Strait") %>% 
  mutate(Designation = "San Pablo Bay")

sanpablo2_union <- st_union(sanpablo2$geometry, by_feature= FALSE)
plot(sanpablo2_union)
```




## scenario 1, 2, 3, 4
```{r}
region_scenarios <- Regions %>% 
      mutate(Scenario1 = case_when(
                                  # far west
                                  SubRegion == "San Pablo Bay" | 
                                  SubRegion == "Carquinez Strait" | 
                                  SubRegion == "Lower Napa River" ~ "Far West",
                                  # west
                                  SubRegion == "West Suisun Bay" |
                                  SubRegion == "Mid Suisun Bay" |
                                  SubRegion == "Grizzly Bay" | 
                                  SubRegion == "Suisun Marsh" |
                                  SubRegion == "Honker Bay" |
                                  SubRegion == "Confluence" ~ "West",
                                  # north
                                  SubRegion == "Lower Sacramento River" ~ "North",
                                  Region == "North" ~ "North",
                                  # south
                                  SubRegion == "Lower San Joaquin River" ~ "South",
                                  Region == "South" ~ "South",
                                  TRUE ~ "Other")) %>% 
    mutate(Scenario2 = case_when(
                                  # far west
                                  SubRegion == "San Pablo Bay" ~ "Far West",
                                  # north
                                  Region == "North" ~ "North",
                                  # south
                                  Region == "South" ~ "South",
                                  # west
                                  SubRegion == "Lower Sacramento River" ~ "West",
                                  TRUE ~ "West")) %>% 
  mutate(Scenario3 = case_when (
                                  # far west
                                  SubRegion == "San Pablo Bay" |
                                  SubRegion == "Lower Napa River" ~ "Far West",
                                  # north
                                  Scenario1 == "North" ~ "North",
                                  # south
                                  Scenario1 == "South" ~ "South",
                                  # west
                                  TRUE ~ "West")) %>% 
  mutate(Scenario4 = case_when(
                                  # far west
                                  Scenario1 == "Far West" ~ "Far West",
                                  # north
                                  Scenario2 == "North" ~ "North",
                                  # south
                                  Scenario2 == "South" ~ "South",
                                  # west
                                  TRUE ~ "West"))
  

View(region_scenarios)

# create simple feature
region_scenarios_sf <- st_as_sf(region_scenarios, crs = 4326) %>% 
              st_transform(crs=4326)


# use st_union code to combine these designated polygons for each scenario

# scenario 1 - two approaches
scenario1 <- region_scenarios %>% 
  select(Scenario1, geometry)
st_combine(scenario1)
st_crs(scenario1, crs=4326)
plot(st_union(scenario1, by_feature= TRUE))

scenario1b <- region_scenarios_sf %>% 
  select(Scenario1, geometry) 
plot1 <- ggplot(scenario1b)+
  geom_sf(aes(fill=Scenario1))+
  scale_fill_viridis_d(name="Region")+
  theme_bw()+
  labs(title="Scenario 1")
plot1

# scenario 2
scenario2 <- region_scenarios %>% 
  select(Scenario2, geometry)
st_combine(scenario2)
plot(st_union(scenario2, by_feature= TRUE))

scenario2b <- region_scenarios_sf %>% 
  select(Scenario2, geometry) 
plot2 <- ggplot(scenario2b)+
  geom_sf(aes(fill=Scenario2))+ 
  labs(title="Scenario 2")+
  scale_fill_viridis_d(name="Region")+
  theme_bw()+
  labs(title="Scenario 2")
plot2

# scenario 3
scenario3 <- region_scenarios %>% 
  select(Scenario3, geometry)
st_combine(scenario3)
plot(st_union(scenario3, by_feature= TRUE))

scenario3b <- region_scenarios_sf %>% 
  select(Scenario3, geometry) 
plot3 <- ggplot(scenario3b)+
  geom_sf(aes(fill=Scenario3))+ 
  labs(title="Scenario 3")+
  scale_fill_viridis_d(name="Region")+
  theme_bw()+
  labs(title="Scenario 3")
plot3

# scenario 4
scenario4 <- region_scenarios %>% 
  select(Scenario4, geometry)
st_combine(scenario4)
plot(st_union(scenario4, by_feature= TRUE))

scenario4b <- region_scenarios_sf %>% 
  select(Scenario4, geometry) 
plot4 <- ggplot(scenario4b)+
  geom_sf(aes(fill=Scenario4))+ 
  labs(title="Scenario 4")+
  scale_fill_viridis_d(name="Region")+
  theme_bw()+
  labs(title="Scenario 4")
plot4

plot1 + plot2 + plot3 + plot4 + plot_layout(nrow=2)
```

## station densities
```{r}
scenario1_stations <- st_intersection(scenario1b, station_points)
scenario2_stations <- st_intersection(scenario2b, station_points)
scenario3_stations <- st_intersection(scenario3b, station_points)
scenario4_stations <- st_intersection(scenario4b, station_points)

# scenario 1 with stations
plot1b <- ggplot()+
  geom_sf(data=scenario1b, aes(fill=Scenario1))+
  geom_sf(data=scenario1_stations, aes(color=Survey))+
  scale_fill_grey(name="Region")+
  scale_color_viridis_d(name="Survey")+
  labs(title="Scenario 1")
plot1b

# scenario 2 with stations
plot2b <- ggplot()+
  geom_sf(data=scenario2b, aes(fill=Scenario2))+
  geom_sf(data=scenario2_stations, aes(color=Survey))+
  scale_fill_grey(name="Region")+
  scale_color_viridis_d(name="Survey")+
  labs(title="Scenario 2")
plot2b

# scenario 3 with stations
plot3b <- ggplot()+
  geom_sf(data=scenario3b, aes(fill=Scenario3))+
  geom_sf(data=scenario3_stations, aes(color=Survey))+
  scale_fill_grey(name="Region")+
  scale_color_viridis_d(name="Survey")+
  labs(title="Scenario 3")
plot3b

# scenario 4 with stations
plot4b <- ggplot()+
  geom_sf(data=scenario4b, aes(fill=Scenario4))+
  geom_sf(data=scenario4_stations, aes(color=Survey))+
  scale_fill_grey(name="Region")+
  scale_color_viridis_d(name="Survey")+
  labs(title="Scenario 4")
plot4b

plot1b + plot2b + plot3b + plot4b + plot_layout(nrow=2)
```


## identify which regions the points fall within
```{r}
scenario1_count <- scenario1_stations %>% 
  select(Scenario1, Survey) %>% 
  rename(Scenario=Scenario1) %>% 
  mutate(Count=1) %>% 
  group_by(Scenario, Survey) %>% 
  summarize(Count=sum(Count)) %>%
  tibble() %>%  
  pivot_wider(id_cols= "Scenario", names_from="Survey", values_from="Count") %>% 
  mutate(Region=Scenario,Scenario="1")
View(scenario1_count)

scenario2_count <- scenario2_stations %>% 
  select(Scenario2, Survey) %>% 
  rename(Scenario=Scenario2) %>% 
  mutate(Count=1) %>% 
  group_by(Scenario, Survey) %>% 
  summarize(Count=sum(Count)) %>%
  tibble() %>%  
  pivot_wider(id_cols= "Scenario", names_from="Survey", values_from="Count") %>% 
  mutate(Region=Scenario, Scenario="2")
View(scenario2_count)

scenario3_count <- scenario3_stations %>% 
  select(Scenario3, Survey) %>% 
  rename(Scenario=Scenario3) %>% 
  mutate(Count=1) %>% 
  group_by(Scenario, Survey) %>% 
  summarize(Count=sum(Count)) %>%
  tibble() %>%  
  pivot_wider(id_cols= "Scenario", names_from="Survey", values_from="Count") %>% 
  mutate(Region=Scenario,Scenario="3")
View(scenario3_count)

scenario4_count <- scenario4_stations %>%
  select(Scenario4, Survey) %>% 
  rename(Scenario=Scenario4) %>% 
  mutate(Count=1) %>% 
  group_by(Scenario, Survey) %>% 
  summarize(Count=sum(Count)) %>%
  tibble() %>%  
  pivot_wider(id_cols= "Scenario", names_from="Survey", values_from="Count") %>% 
  mutate(Region=Scenario,Scenario="4")
View(scenario4_count)

scenario_counts <- bind_rows(scenario1_count, scenario2_count, scenario3_count, scenario4_count) %>% 
  select(Scenario, Region, `EMP Benthic`: `Delta Juvenile Fish Monitoring Program`)
print(scenario_counts)

scenario_counts %>% write_csv("data/stations/region_scenarios_and_station_counts.csv")
```



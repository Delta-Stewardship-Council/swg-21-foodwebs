---
title: "Benthic Sampling Effort"
author: "Jeanette Clark"
date: "10/25/2021"
output: html_document
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = '../docs',
      envir = globalenv()
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(DT)
library(leaflet)
library(sf)
library(janitor)
```


## Read and preprocess data

* remove the L,R,C (left, right, center) from site names, so we can group those counts together
    - may need to verify this doesn't create any statistical artifacts
* create a monthly time stamp
* take mean of lat/lon for each site
    -  some sites moved slightly, and some years don't have lat/lons for the sites. Assume minor site movement is negligable (may need to verify)

```{r}
ben_raw <- tryCatch(
  read_csv("data_raw/DWR Benthic raw count data 1975-2020 2021_10_01.csv", show_col_types = FALSE),
  error=function(cond) {
    message(paste("Benthic file does not exist locally, so get it from the KNB."))
    ben_raw <- read_csv(url("https://knb.ecoinformatics.org/knb/d1/mn/v2/object/urn:uuid:25b7befd-e931-4a50-9bf6-14715561f64a", method = "libcurl"), show_col_types = FALSE)
    return(ben_raw)
  }
)
```



```{r, message=FALSE}
ben <- ben_raw  %>% 
  mutate(StationClean =  gsub("-[A-Z]","",StationCode)) %>% 
  mutate(mon = lubridate::ym(paste0(Year, Month, sep = "-"))) %>% 
  group_by(StationClean) %>% 
  mutate(Latitude = mean(Latitude, na.rm = T), 
         Longitude = mean(Longitude, na.rm = T)) %>% 
  ungroup()
```



```{r}
sites_mon <- ben  %>% 
  distinct(StationClean, Latitude, Longitude, mon) 

sites <- ben %>% 
  group_by(StationClean, Latitude, Longitude) %>% 
  summarise(n_months = length(unique(mon)), .groups  =  "drop") %>% 
  st_as_sf(coords = c('Longitude','Latitude'), crs = 4326,  remove = FALSE)
```


## Sites that were sampled each month


```{r, echo=F}
ggplot(sites_mon, aes(x = mon, y = StationClean), size = 3) +
  geom_point() +
  theme_classic()
```


## Table of site information

```{r, echo = FALSE}
datatable(as.data.frame(sites))
```

## Core Stations

```{r}
core <- c("P8",
          "MD10",
          "D8",
          "D7",
          "D6",
          "D41",
          "D4",
          "D28A",
          "D26",
          "C3",
          "C10")

core_data <-  sites_mon %>% 
  filter(StationClean %in% core)
```


```{r, echo=F}
ggplot(core_data, aes(x = mon, y = StationClean), size = 3) +
  geom_point() +
  theme_classic()
```

## Location of sites, sized according to total number of months sampled

Red are core sites

```{r, message = FALSE, echo = FALSE}
sites_core <- sites %>% 
  filter(StationClean %in% core)


leaflet(sites) %>% 
  addTiles() %>% 
  addCircleMarkers(data = sites,
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = ~(n_months/50), # arbitrary scaling
                         fillColor = "blue",
                         fillOpacity = 1,
                         weight = 0.25,
                         color = "black",
                         label = ~StationClean) %>% 
  addCircleMarkers(data = sites_core,
                         lat = ~Latitude,
                         lng = ~Longitude,
                         radius = ~(n_months/50), # arbitrary scaling
                         fillColor = "red",
                         fillOpacity = 1,
                         weight = 0.25,
                         color = "black",
                         label = ~StationClean)
```

## Annual Average CPUE (potentially problematic)

For both clam genera, Potamocorbula and Corbicula.

Code adapted from [Sarah's work here](https://github.com/emp-des/annual-report-graphs/blob/master/Benthic/Benthic_AR_Template.Rmd)

```{r}
ben_clams  <- ben %>%
  filter(Genus %in% c("Potamocorbula", "Corbicula")) %>% 
  group_by(Month, Year, StationCode) %>%
  mutate(Grab_Count = max(Grab)) %>%
  ungroup() %>%
  group_by(Month, Year) %>%
  mutate(Station_Count = n_distinct(StationCode),
         Grab_Count = Grab_Count*Station_Count) %>%
  ungroup() %>%
  group_by(Genus, Month, Year, Grab_Count, Station_Count) %>%
  summarize(Orgs_Total = sum(Count, na.rm = TRUE), .groups = "drop")



ben_clams$Date <- with(ben_clams, paste(Month, Year))

# get grab variable
df_grab_vari <- ben_clams[!duplicated(ben_clams$Date),]

```

Examine where data dropping  might havee issues

```{r}
i <- which(!duplicated(ben_clams$Date))

ben_clams$keep <- "Yes"
ben_clams$keep[i] <- "No"

DT::datatable(select(ben_clams, keep, Grab_Count, Month, Year, Station_Count) %>% 
                arrange(Year))

```


```{r}

df_grab_vari <- df_grab_vari %>%
  group_by(Year) #%>%
  summarize(Grab_Count = sum(Grab_Count), .groups = "drop") 

# create df of totals by year
df_year_sums <- ben_clams %>%
  group_by(Genus, Year) %>%
  summarize(Orgs_Total = sum(Orgs_Total, na.rm = TRUE), .groups = "drop") 

df_year_sums <-  merge(df_year_sums, df_grab_vari, by = 'Year', all.x=FALSE, all.y=FALSE)

df_year_CPUE <- df_year_sums %>%
  mutate(CPUE_Total = Orgs_Total/Grab_Count/0.052) %>%
  select(-Orgs_Total, -Grab_Count) %>% 
  pivot_wider(names_from = Genus, values_from = CPUE_Total) %>% 
  rename(corbicula_cpue = Corbicula,
         potamocorbula_cpue = Potamocorbula)  %>% 
  clean_names()

```


##  Corrected CPUE calcs

**Needs review by Sarah**

```{r}
grabs_month  <- ben %>%
  mutate(Date = paste(Month, Year)) %>% 
  group_by(Date, StationCode, .drop = TRUE) %>%
  mutate(Grab_Count = max(Grab)) %>%
  distinct(Date, StationCode, Grab_Count) %>% 
  group_by(Date) %>% 
  summarise(Grab_Count = sum(Grab_Count))

ben_clams_month <- ben %>% 
  mutate(Date = paste(Month, Year)) %>%
  group_by(Genus, Date) %>%
  summarize(Orgs_Total = sum(Count, na.rm = TRUE), .groups = "drop") %>% 
  left_join(grabs_month) %>% 
  mutate(CPUE_Total = Orgs_Total/Grab_Count/0.052) %>% 
  mutate(Date = lubridate::my(Date))  %>% 
  filter(Genus %in% c("Potamocorbula", "Corbicula"))

ben_clams_month_wide <- ben_clams_month %>% 
  select(-Orgs_Total, -Grab_Count) %>% 
  pivot_wider(names_from = Genus, values_from = CPUE_Total) %>% 
  rename(corbicula_cpue = Corbicula,
         potamocorbula_cpue = Potamocorbula)  %>% 
  clean_names()

```

```{r}
grabs_year <- grabs_month %>% 
  mutate(Date = lubridate::my(Date)) %>% 
  mutate(Year = lubridate::year(Date)) %>% 
  group_by(Year) %>% 
  summarise(Grab_Count = sum(Grab_Count))


ben_clams_year <- ben %>% 
  group_by(Genus, Year) %>%
  summarize(Orgs_Total = sum(Count, na.rm = TRUE), .groups = "drop") %>% 
  left_join(grabs_year) %>% 
  mutate(CPUE_Total = Orgs_Total/Grab_Count/0.052) %>% 
  filter(Genus %in% c("Potamocorbula", "Corbicula"))


ben_clams_year_wide <- ben_clams_year %>% 
  select(-Orgs_Total, -Grab_Count) %>% 
  pivot_wider(names_from = Genus, values_from = CPUE_Total) %>% 
  rename(corbicula_cpue = Corbicula,
         potamocorbula_cpue = Potamocorbula)  %>% 
  clean_names()

```



```{r, echo = FALSE}
ggplot() +
  geom_line(data = ben_clams_month_wide, aes(x = date,  y = corbicula_cpue), color = "red") +
  geom_line(data = ben_clams_month_wide, aes(x = date,  y = potamocorbula_cpue), color = "blue") +
    geom_line(data = ben_clams_year_wide, aes(x = as.Date(paste0(year, "-01-01")),  y = corbicula_cpue), color = "firebrick") +
  geom_line(data = ben_clams_year_wide, aes(x = as.Date(paste0(year, "-01-01")),  y = potamocorbula_cpue), color = "dark blue") +
  theme_classic() +
  labs(x= "Year", y = "CPUE", title = "Annual Mean CPUE for Corbicula (red) and Potamocorbula (blue)")
```


```{r}
write_csv(df_year_CPUE, "annual_averages/benthic.csv")
```



---
title: "Annual model - Regions"
author: "Tanya Rogers"
date: "12/15/2021"
output: html_document
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = '../docs',
      knit_root_dir = '..',
      envir = globalenv()
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, message=FALSE}
library(dplyr)
#library(psych) #for pairs.panels, but could use other packages, e.g. GGalley
library(lavaan)
library(semPlot)
library(DiagrammeR)
library(tidyr)
library(ggplot2)
```

### Import data

```{r dataprep}
combined=read.csv("data/annual_averages/annual_data_compiled_regions.csv",stringsAsFactors = F)
cnames=read.csv("analysis/column_names_region.csv", stringsAsFactors = F)
dsub=filter(combined, Year>=1975) %>% arrange(Region,Year)
focaldata=dsub[,cnames$Datacolumn]
fvars=cnames$Shortname
colnames(focaldata)=fvars
regions=unique(focaldata$region)
regionorder=c("West","North","South")
years=1975:2021

focaldata$tzoop=focaldata$hcope+focaldata$clad+focaldata$mysid+focaldata$pcope
focaldata$hzoop=focaldata$hcope+focaldata$clad
focaldata$pzoop=focaldata$mysid+focaldata$pcope
fvars=c(fvars,"tzoop","hzoop","pzoop")
cnames=rbind(cnames,data.frame(Longname=NA,Shortname=c("tzoop","hzoop","pzoop"),
                               Diagramname=c("Total Zooplankton\nBiomass",
                                             "Total Herbivorous\nZooplankton",
                                             "Total Predatory\nZooplankton"),
                               Datacolumn=NA,Log=c("yes","yes","yes")))

#focal variables
varnames=c("temp", "flow","nitrate","ammonia","dophos","chla","hcope","clad","amphi","pcope","mysid","potam","corbic","sside","estfish_bsot","estfish_bsmt","tzoop","hzoop","pzoop")

source("analysis/myLavaanPlot.r")
```

### Data prep

Log transform, scale

```{r prep}
#log transform
logvars=fvars[cnames$Log=="yes"]
logtrans=function(x) {
  x2=x[which(!is.na(x))]
  if(any(x2==0)) {log(x+min(x2[which(x2>0)],na.rm=T))}
  else {log(x)}
}
focaldatalog = focaldata %>% 
  mutate_at(logvars,logtrans)

#scale data
fdr0=focaldatalog
tvars=fvars[-(1:2)]

fdr=fdr0 %>% group_by(region) %>% 
  #lag
  mutate_at(tvars,list("1"=lag)) %>% 
  #scale
  mutate_at(-(1:2),scale) %>% 
  ungroup() %>% 
  as.data.frame() 

#detrended data
fdr_dtr=fdr0 %>% group_by(region) %>% 
  #detrend
  mutate_at(tvars,function(x) { 
    x<<-x
    if(!all(is.na(x))) {
      if((length(which(x==0))/length(x))<0.5) {
        x2<<-x
        x2[x2==0]=NA
        res<<-residuals(lm(x2~years))
        out=x
        out[which(!is.na(x2))]=res
        return(out)
      } else {return(x)}
    } else {return(x)}
  }) %>%
  #lag
  mutate_at(tvars,list("1"=lag)) %>% 
  #scale
  mutate_at(-(1:2),scale) %>% 
  ungroup() %>% 
  as.data.frame() 
```

### Time series plots

```{r timeseries, fig.width=8, fig.height=11, echo=FALSE, warning=FALSE}
plot1=select(focaldata,region,year,varnames) %>% 
  gather(Var,Value,varnames) %>% 
  mutate(Var=factor(Var,levels = varnames),region=factor(region,levels=regionorder))
ggplot(plot1,aes(x=year,y=Value)) +
  facet_grid(Var~region, scales="free_y") +
  geom_line() +
  theme_bw() +
  labs(title = "Original Units")

plot2=select(fdr,region,year,varnames) %>% 
  gather(Var,Value,varnames) %>% 
  mutate(Var=factor(Var,levels = varnames),region=factor(region,levels=regionorder))
ggplot(plot2,aes(x=year,y=Value)) +
  facet_grid(Var~region, scales="free_y") +
  geom_line() +
  theme_bw() +
  labs(title = "Log scaled within region")

plot3=select(fdr_dtr,region,year,varnames) %>% 
  gather(Var,Value,varnames) %>% 
  mutate(Var=factor(Var,levels = varnames),region=factor(region,levels=regionorder))
ggplot(plot3,aes(x=year,y=Value)) +
  facet_grid(Var~region, scales="free_y") +
  geom_line() +
  theme_bw() +
  labs(title = "Log scaled detrended")
```

### Cross-correlation matrices  
(only sig correlations shown... no correction for multiple comparisons)

```{r cc, fig.width=7, fig.height=6, echo=FALSE}
#lag 0
lags0=expand.grid(region=regions,V1=varnames,V2=varnames,Cor=NA,P=NA,
                  stringsAsFactors = F)
for(i in 1:nrow(lags0)) {
  v1=fdr[fdr$region==lags0$region[i],lags0$V1[i]]
  v2=fdr[fdr$region==lags0$region[i],lags0$V2[i]]
  if(!all(is.na(v1)) & !all(is.na(v2))) {
    tccf=cor.test(v1,v2)
    lags0$Cor[i]=tccf$estimate
    lags0$P[i]=tccf$p.value
  }
}
lags0$V1=factor(lags0$V1,levels = varnames)
lags0$V2=factor(lags0$V2,levels = varnames)
lags0$region=factor(lags0$region,levels = regionorder)
ggplot(filter(lags0,P<0.05,V1!=V2), aes(x=V2,y=V1,fill=Cor)) +
  facet_wrap(.~region, nrow=2, scales = "free", drop=F, strip.position = "right",dir = "v") +
  geom_tile() +
  geom_abline(slope=1,intercept = 0) +
  scale_fill_gradient2() +
  theme_bw() +
  labs(x="V2 (t)", y="V1 (t)", title = "lag 0 cross-cor") +
  scale_x_discrete(expand = expand_scale(mult = 0),drop=F) +
  scale_y_discrete(expand = expand_scale(mult = 0),drop=F) +
  theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1))

#lag 1
lags1=expand.grid(region=regions,V1=varnames,V2=varnames,Cor=NA,P=NA,
                  stringsAsFactors = F)
for(i in 1:nrow(lags1)) {
  v1=fdr[fdr$region==lags1$region[i],lags1$V1[i]]
  v2=fdr[fdr$region==lags1$region[i],lags1$V2[i]]
  if(!all(is.na(v1)) & !all(is.na(v2))) {
    tccf=cor.test(v1,lag(v2,1))
    lags1$Cor[i]=tccf$estimate
    lags1$P[i]=tccf$p.value
  }
}
lags1$V1=factor(lags1$V1,levels = varnames)
lags1$V2=factor(lags1$V2,levels = varnames)
lags1$region=factor(lags1$region,levels = regionorder)
ggplot(filter(lags1,P<0.05,V1!=V2), aes(x=V2,y=V1,fill=Cor)) +
  facet_wrap(.~region, nrow=2, scales = "free", drop=F, strip.position = "right",dir = "v") +
  geom_tile() +
  geom_abline(slope=1,intercept = 0) +
  scale_fill_gradient2() +
  theme_bw() +
  labs(x="V2 (t-1)", y="V1 (t)", title = "lag 1 cross-cor") +
  scale_x_discrete(expand = expand_scale(mult = 0),drop=F) +
  scale_y_discrete(expand = expand_scale(mult = 0),drop=F) +
  theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1))

#lag 1 seasonality removed
lags1dtr=expand.grid(region=regions,V1=varnames,V2=varnames,Cor=NA,P=NA,
                  stringsAsFactors = F)
for(i in 1:nrow(lags1dtr)) {
  v1=fdr_dtr[fdr_dtr$region==lags1dtr$region[i],lags1dtr$V1[i]]
  v2=fdr_dtr[fdr_dtr$region==lags1dtr$region[i],lags1dtr$V2[i]]
  if(!all(is.na(v1)) & !all(is.na(v2))) {
    tccf=cor.test(v1,v2)
    lags1dtr$Cor[i]=tccf$estimate
    lags1dtr$P[i]=tccf$p.value
  }
}
lags1dtr$V1=factor(lags1dtr$V1,levels = varnames)
lags1dtr$V2=factor(lags1dtr$V2,levels = varnames)
lags1dtr$region=factor(lags1dtr$region,levels = regionorder)
ggplot(filter(lags1dtr,P<0.05,V1!=V2), aes(x=V2,y=V1,fill=Cor)) +
  facet_wrap(.~region, nrow=2, scales = "free", drop=F, strip.position = "right",dir = "v") +
  geom_tile() +
  geom_abline(slope=1,intercept = 0) +
  scale_fill_gradient2() +
  theme_bw() +
  labs(x="V2 (t-1)", y="V1 (t)",title = "lag 0 cross-cor, detrended") +
  scale_x_discrete(expand = expand_scale(mult = 0),drop=F) +
  scale_y_discrete(expand = expand_scale(mult = 0),drop=F) +
  theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1))
```

```{r bivariate, fig.width=9, fig.height=9, echo=FALSE, eval=FALSE}
psych::pairs.panels(dplyr::select(fdr, year, flow, temp, secchi, chla, hcope, clad, pcope, mysid, estfish, sside, potam, corbic, dophos),lm = T, bg=c("red","yellow","blue")[factor(fdr$region)],pch=21)
```

*Fish indices are not correlated in S and N!*

### SEM model

With and without detrending.

```{r}
#west has no ssides, corbic

# modwest='zoop=~hcope+mysid
#         fish=~estfish_bsmt+estfish_bsot
#         zoop~chla+potam+flow
#         chla~potam+flow
#         fish~zoop+flow
# '

modwest='chla~potam+flow
        tzoop~chla+potam+flow
        estfish_bsmt~tzoop+flow
        estfish_bsot~tzoop+flow
'

modfitwest=sem(modwest, data=filter(fdr,region=="West"))
modfitwest_dtr=sem(modwest, data=filter(fdr_dtr,region=="West"))
summary(modfitwest, standardized=T, rsq=T)
summary(modfitwest_dtr, standardized=T, rsq=T)
# par(mfrow=c(1,2))
# semPaths(modfitwest, "std", edge.label.cex = 1, residuals = F)
# semPaths(modfitwest, "par", edge.label.cex = 1, residuals = F)

labelswest <- createLabels(modfitwest, cnames)

# residuals(modfitwest)
# modificationindices(modfitwest)
```

```{r}
# modnorth='zoop=~hcope+mysid
#         #fish=~estfish_bsmt+estfish_bsot
#         zoop~chla+potam+flow
#         chla~potam+flow
#         estfish_bsmt~zoop+flow
#         estfish_bsot~zoop+flow
# '
# modnorth='zoop=~clad
#         zoop~chla+corbic+potam+flow
#         chla~corbic+potam+flow
#         estfish_bsmt~zoop+flow+sside+chla
#         estfish_bsot~zoop+flow+sside+chla
# '

modnorth='chla~corbic+potam+flow
        tzoop~chla+corbic+potam+flow
        estfish_bsmt~tzoop+flow+chla
        estfish_bsot~tzoop+flow
'

modfitnorth=sem(modnorth, data=filter(fdr,region=="North"))
modfitnorth_dtr=sem(modnorth, data=filter(fdr_dtr,region=="North"))
summary(modfitnorth, standardized=T, rsq=T)
summary(modfitnorth_dtr, standardized=T, rsq=T)
# par(mfrow=c(1,2))
# semPaths(modfitnorth, "std", edge.label.cex = 1, residuals = F)
# semPaths(modfitnorth, "par", edge.label.cex = 1, residuals = F)

labelsnorth <- createLabels(modfitnorth, cnames)

# residuals(modfitnorth)
# modificationindices(modfitnorth)
```

```{r}
#no potam
# modsouth='zoop=~hcope+mysid
#         #fish=~estfish_bsmt+estfish_bsot
#         zoop~chla+corbic+flow
#         chla~corbic+flow
#         estfish_bsmt~zoop+flow
#         estfish_bsot~zoop+flow
# '

modsouth='chla~corbic+flow
        tzoop~chla+corbic+flow
        estfish_bsmt~tzoop+flow+corbic
        estfish_bsot~tzoop+flow+corbic
'

modfitsouth=sem(modsouth, data=filter(fdr,region=="South"))
modfitsouth_dtr=sem(modsouth, data=filter(fdr_dtr,region=="South"))
summary(modfitsouth, standardized=T, rsq=T)
summary(modfitsouth_dtr, standardized=T, rsq=T)
# par(mfrow=c(1,2))
# semPaths(modfitsouth, "std", edge.label.cex = 1, residuals = F)
# semPaths(modfitsouth, "par", edge.label.cex = 1, residuals = F)

labelssouth <- createLabels(modfitsouth, cnames)

# residuals(modfitsouth)
# modificationindices(modfitsouth)
```


### Nice plots 

Original units

*West*

```{r, echo=FALSE}
myLavaanPlot(model=modfitwest, labels=labelswest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))

```

*North*

```{r, echo=FALSE}
myLavaanPlot(model=modfitnorth, labels=labelsnorth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

*South*

```{r, echo=FALSE}
myLavaanPlot(model=modfitsouth, labels=labelssouth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

Detrended

*West*

```{r, echo=FALSE}
myLavaanPlot(model=modfitwest_dtr, labels=labelswest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))

```

*North*

```{r, echo=FALSE}
myLavaanPlot(model=modfitnorth_dtr, labels=labelsnorth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

*South*

```{r, echo=FALSE}
myLavaanPlot(model=modfitsouth_dtr, labels=labelssouth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

### SEM model (h and p zoop split)

With and without detrending.

```{r}
#west has no ssides, corbic

modwest='chla~potam
        potam~flow
        hzoop~chla+potam+flow
        pzoop~chla+potam+flow+hzoop
        estfish_bsmt~hzoop+pzoop+flow
        estfish_bsot~hzoop+pzoop+flow
'

modfitwest=sem(modwest, data=filter(fdr,region=="West"))
modfitwest_dtr=sem(modwest, data=filter(fdr_dtr,region=="West"))
summary(modfitwest, standardized=T, rsq=T)
summary(modfitwest_dtr, standardized=T, rsq=T)

labelswest <- createLabels(modfitwest, cnames)

# residuals(modfitwest)
# modificationindices(modfitwest)
```

```{r}

modnorth='chla~corbic+potam
        potam~flow
        corbic~flow
        hzoop~chla+corbic+potam+flow
        pzoop~chla+corbic+potam+flow+hzoop
        estfish_bsmt~hzoop+pzoop+flow
        estfish_bsot~hzoop+pzoop+flow
'

modfitnorth=sem(modnorth, data=filter(fdr,region=="North"))
modfitnorth_dtr=sem(modnorth, data=filter(fdr_dtr,region=="North"))
summary(modfitnorth, standardized=T, rsq=T)
summary(modfitnorth_dtr, standardized=T, rsq=T)

labelsnorth <- createLabels(modfitnorth, cnames)

# residuals(modfitnorth)
# modificationindices(modfitnorth)
```

```{r}
#no potam

modsouth='chla~corbic
        corbic~flow
        hzoop~chla+corbic+flow
        pzoop~chla+corbic+flow+hzoop
        estfish_bsmt~hzoop+pzoop+flow+corbic
        estfish_bsot~hzoop+pzoop+flow+corbic
'

modfitsouth=sem(modsouth, data=filter(fdr,region=="South"))
modfitsouth_dtr=sem(modsouth, data=filter(fdr_dtr,region=="South"))
summary(modfitsouth, standardized=T, rsq=T)
summary(modfitsouth_dtr, standardized=T, rsq=T)

labelssouth <- createLabels(modfitsouth, cnames)

# residuals(modfitsouth)
# modificationindices(modfitsouth)
```


### Nice plots 

Original units

*West*

```{r, echo=FALSE}
myLavaanPlot(model=modfitwest, labels=labelswest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))

```

*North*

```{r, echo=FALSE}
myLavaanPlot(model=modfitnorth, labels=labelsnorth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

*South*

```{r, echo=FALSE}
myLavaanPlot(model=modfitsouth, labels=labelssouth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

Detrended

*West*

```{r, echo=FALSE}
myLavaanPlot(model=modfitwest_dtr, labels=labelswest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))

```

*North*

```{r, echo=FALSE}
myLavaanPlot(model=modfitnorth_dtr, labels=labelsnorth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

*South*

```{r, echo=FALSE}
myLavaanPlot(model=modfitsouth_dtr, labels=labelssouth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

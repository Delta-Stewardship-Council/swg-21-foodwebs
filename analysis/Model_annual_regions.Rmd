---
title: "Annual model - Regions"
author: "Tanya Rogers"
date: "12/15/2021"
output: html_document
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = '../docs',
      knit_root_dir = '..',
      envir = globalenv()
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, message=FALSE}
library(dplyr)
library(lavaan)
library(DiagrammeR)
library(tidyr)
library(ggplot2)

# For saving SEM diagrams:
library(purrr)
library(DiagrammeRsvg)
library(rsvg)
library(png)
library(grid)
library(ggpubr)
```

### Import data

```{r dataprep}
combined=read.csv("data/annual_averages/annual_data_compiled_regions.csv",stringsAsFactors = F)
cnames=read.csv("analysis/column_names_region.csv", stringsAsFactors = F)
dsub=filter(combined, Year>=1975) %>% arrange(Region,Year)
focaldata=dsub[,cnames$Datacolumn]
fvars=cnames$Shortname
colnames(focaldata)=fvars
regions=unique(focaldata$region)
regionorder=c("West","North","South")
years=1975:2021

focaldata = focaldata %>% 
  mutate(tzoop=hcope+clad+mysid+pcope+rotif_m,
         tzoop_e=hcope_e+clad_e+mysid_e+pcope_e+rotif_e,
         hzoop=hcope+clad+rotif_m,
         hzoop_e=hcope_e+clad_e+rotif_e,
         pzoop=mysid+pcope,
         pzoop_e=mysid_e+pcope_e,
         turbid=-secchi) 
fvars=c(fvars,"tzoop","tzoop_e",
        "hzoop","hzoop_e",
        "pzoop","pzoop_e","turbid")
cnames=rbind(cnames,data.frame(Longname=NA,Shortname=c("tzoop","tzoop_e",
                                                       "hzoop","hzoop_e",
                                                       "pzoop","pzoop_e","turbid"),
                               Diagramname=c("total zooplankton",
                                             "total zooplankton\nenergy",
                                             "herbivorous\nzooplankton",
                                             "herbivorous\nzooplankton\nenergy",
                                             "predatory\nzooplankton",
                                             "predatory\nzooplankton\nenergy",
                                             "turbidity"),
                               Datacolumn=NA,Log=c(rep("yes",6),"no"),
                               Color=c("black","black","#ED7D31","#ED7D31","#7030A0",
                                       "#7030A0","#4472C4")))

#focal variables
varnames=c("temp","flow","turbid","chla","hzoop","pzoop","tzoop","amphi","potam","corbic","estfish","estfish_bsmt","estfish_stn")

source("analysis/myLavaanPlot.r")
source("analysis/semDiagramFunctions.r")
```

### Data prep

Log transform, scale

```{r prep}
#log transform
logvars=fvars[cnames$Log=="yes"]
logtrans=function(x) {
  x2=x[which(!is.na(x))]
  if(any(x2==0)) {log(x+min(x2[which(x2>0)],na.rm=T))}
  else {log(x)}
}
focaldatalog = focaldata %>% 
  mutate(flow=flow-min(flow,na.rm=T)) %>%  #get rid of negative flow values
  mutate_at(logvars,logtrans)

#scale data
fdr0=focaldatalog
tvars=fvars[-(1:2)]

fdr=fdr0 %>% group_by(region) %>% 
  #lag
  #mutate_at(tvars,list("1"=lag)) %>% 
  #scale
  mutate_at(-(1:2),scale) %>% 
  ungroup() %>% 
  as.data.frame() 

#detrended data
fdr_dtr=fdr0 %>% group_by(region) %>% 
  #detrend
  mutate_at(tvars,function(x) { 
    x<<-x
    if(!all(is.na(x))) {
      if((length(which(x==0))/length(x))<0.5) {
        x2<<-x
        x2[x2==0]=NA
        res<<-residuals(lm(x2~years))
        out=x
        out[which(!is.na(x2))]=res
        return(out)
      } else {return(x)}
    } else {return(x)}
  }) %>%
  #lag
  #mutate_at(tvars,list("1"=lag)) %>% 
  #scale
  mutate_at(-(1:2),scale) %>% 
  ungroup() %>% 
  as.data.frame() 
```

### Time series plots

```{r timeseries, fig.width=8, fig.height=10, echo=FALSE, warning=FALSE}
plot1=select(focaldata,region,year,varnames) %>% 
  gather(Var,Value,varnames) %>% 
  mutate(Var=factor(Var,levels = varnames),region=factor(region,levels=regionorder))
ggplot(plot1,aes(x=year,y=Value)) +
  facet_grid(Var~region, scales="free_y") +
  geom_line() +
  theme_bw() +
  labs(title = "Original Units")

plot2=select(fdr,region,year,varnames) %>% 
  gather(Var,Value,varnames) %>% 
  mutate(Var=factor(Var,levels = varnames),region=factor(region,levels=regionorder))
ggplot(plot2,aes(x=year,y=Value)) +
  facet_grid(Var~region, scales="free_y") +
  geom_line() +
  theme_bw() +
  labs(title = "Log scaled")

plot3=select(fdr_dtr,region,year,varnames) %>% 
  gather(Var,Value,varnames) %>% 
  mutate(Var=factor(Var,levels = varnames),region=factor(region,levels=regionorder))
ggplot(plot3,aes(x=year,y=Value)) +
  facet_grid(Var~region, scales="free_y") +
  geom_line() +
  theme_bw() +
  labs(title = "Log scaled detrended")
```

### Other useful plots

Breakdown of total zooplankton biomass.

```{r zoops, echo=FALSE}
plot4=select(focaldata,region,year,hcope,pcope,clad,mysid,rotif_m) %>% 
  gather(Var,Value,hcope:rotif_m) %>% 
  mutate(region=factor(region,levels=regionorder))
ggplot(plot4,aes(x=year,y=Value,fill=Var)) +
  facet_grid(region~., scales="free_y") +
  geom_area() +
  theme_bw() + scale_fill_brewer(palette = "Dark2") +
  labs(title = "Original units")
```

Similarity of fish indices.

```{r fish, echo=FALSE}
plot5=select(fdr,region,year,estfish,estfish_bsmt,estfish_stn) %>% 
  gather(Var,Value,estfish,estfish_bsmt,estfish_stn) %>% 
  mutate(region=factor(region,levels=regionorder))
ggplot(plot5,aes(x=year,y=Value,color=Var)) +
  facet_grid(region~., scales="free_y") +
  geom_line(size=1) +
  theme_bw() + scale_color_brewer(palette = "Dark2") +
  labs(title = "Log scaled")

plot6=select(fdr_dtr,region,year,estfish,estfish_bsmt,estfish_stn) %>% 
  gather(Var,Value,estfish,estfish_bsmt,estfish_stn) %>% 
  mutate(region=factor(region,levels=regionorder))
ggplot(plot6,aes(x=year,y=Value,color=Var)) +
  facet_grid(region~., scales="free_y") +
  geom_line(size=1) +
  theme_bw() + scale_color_brewer(palette = "Dark2") +
  labs(title = "Log scaled detrended")
```

Correlation between biomass and energy.

```{r}
for(i in 1:length(regions)) {
  dtemp=filter(fdr,region==regions[i])
  print(regions[i])
  print(cor(dtemp$tzoop,dtemp$tzoop_e,use = "p"))
  print(cor(dtemp$hzoop,dtemp$hzoop_e,use = "p"))
  print(cor(dtemp$pzoop,dtemp$pzoop_e,use = "p"))
}
```

### Cross-correlation matrices  
(only sig correlations shown... no correction for multiple comparisons)

```{r ccmat, fig.width=7, fig.height=6, echo=FALSE}
#lag 0
lags0=expand.grid(region=regions,V1=varnames,V2=varnames,Cor=NA,P=NA,
                  stringsAsFactors = F)
for(i in 1:nrow(lags0)) {
  v1=fdr[fdr$region==lags0$region[i],lags0$V1[i]]
  v2=fdr[fdr$region==lags0$region[i],lags0$V2[i]]
  if(!all(is.na(v1)) & !all(is.na(v2))) {
    tccf=cor.test(v1,v2)
    lags0$Cor[i]=tccf$estimate
    lags0$P[i]=tccf$p.value
  }
}
lags0$V1=factor(lags0$V1,levels = varnames)
lags0$V2=factor(lags0$V2,levels = varnames)
lags0$region=factor(lags0$region,levels = regionorder)
ggplot(filter(lags0,P<0.05,V1!=V2), aes(x=V2,y=V1,fill=Cor)) +
  facet_wrap(.~region, nrow=2, scales = "free", drop=F, strip.position = "right",dir = "v") +
  geom_tile() +
  geom_abline(slope=1,intercept = 0) +
  scale_fill_gradient2() +
  theme_bw() +
  labs(x="V2 (t)", y="V1 (t)", title = "lag 0 cross-cor") +
  scale_x_discrete(expand = expand_scale(mult = 0),drop=F) +
  scale_y_discrete(expand = expand_scale(mult = 0),drop=F) +
  theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1))

#lag 0, detrended
lags0dtr=expand.grid(region=regions,V1=varnames,V2=varnames,Cor=NA,P=NA,
                  stringsAsFactors = F)
for(i in 1:nrow(lags0dtr)) {
  v1=fdr_dtr[fdr_dtr$region==lags0dtr$region[i],lags0dtr$V1[i]]
  v2=fdr_dtr[fdr_dtr$region==lags0dtr$region[i],lags0dtr$V2[i]]
  if(!all(is.na(v1)) & !all(is.na(v2))) {
    tccf=cor.test(v1,v2)
    lags0dtr$Cor[i]=tccf$estimate
    lags0dtr$P[i]=tccf$p.value
  }
}
lags0dtr$V1=factor(lags0dtr$V1,levels = varnames)
lags0dtr$V2=factor(lags0dtr$V2,levels = varnames)
lags0dtr$region=factor(lags0dtr$region,levels = regionorder)
ggplot(filter(lags0dtr,P<0.05,V1!=V2), aes(x=V2,y=V1,fill=Cor)) +
  facet_wrap(.~region, nrow=2, scales = "free", drop=F, strip.position = "right",dir = "v") +
  geom_tile() +
  geom_abline(slope=1,intercept = 0) +
  scale_fill_gradient2() +
  theme_bw() +
  labs(x="V2 (t)", y="V1 (t)", title = "lag 0 cross-cor, detrended") +
  scale_x_discrete(expand = expand_scale(mult = 0),drop=F) +
  scale_y_discrete(expand = expand_scale(mult = 0),drop=F) +
  theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1))
```

*Note correlation of fish indices, or lack thereof.*

### SEM model

With and without detrending.

*West*

```{r west}
#1
# modwest='zoop=~hcope+mysid
#         fish=~estfish_bsmt+estfish_bsot
#         zoop~chla+potam+flow
#         chla~potam+flow
#         fish~zoop+flow
# '
#2
# modwest='chla~potam+flow
#         tzoop~chla+potam+flow
#         estfish_bsmt~tzoop+flow
#         estfish_bsot~tzoop+flow
# '
#3
# modwest='chla~potam+flow+temp+turbid
#         tzoop~chla+potam+flow+temp+turbid
#         amphi~chla+potam+flow+temp+turbid
#         estfish_bsmt~tzoop+amphi+flow
#         #estfish_bsot~tzoop+amphi+flow+temp+turbid
#         amphi~~tzoop
# '
#4
# modwest='chla~potam+flow+temp+turbid
#         hzoop~chla+potam+flow+temp+turbid
#         pzoop~chla+potam+flow+temp+turbid+hzoop
#         amphi~chla+potam+flow+temp+turbid
#         estfish_bsmt~hzoop+pzoop+amphi+flow+temp+turbid
#         amphi~~hzoop+pzoop
# '
#5
modwest='chla~potam+flow+temp+turbid
        hzoop~chla+potam+flow+temp+turbid
        pzoop~chla+potam+flow+temp+turbid+hzoop
        fish~hzoop+pzoop+potam+flow+temp+turbid
        fish=~estfish+estfish_stn+estfish_bsmt
'

modfitwest=sem(modwest, data=filter(fdr,region=="West"))
modfitwest_dtr=sem(modwest, data=filter(fdr_dtr,region=="West"))
summary(modfitwest, standardized=T, rsq=T)
summary(modfitwest_dtr, standardized=T, rsq=T)

labelswest <- createLabels(modfitwest, cnames)

# residuals(modfitwest)
# modificationindices(modfitwest)
```

*North*

```{r north}
#1
# modnorth='zoop=~hcope+mysid
#         #fish=~estfish_bsmt+estfish_bsot
#         zoop~chla+potam+flow
#         chla~potam+flow
#         estfish_bsmt~zoop+flow
#         estfish_bsot~zoop+flow
# '
# modnorth='zoop=~clad
#         zoop~chla+corbic+potam+flow
#         chla~corbic+potam+flow
#         estfish_bsmt~zoop+flow+sside+chla
#         estfish_bsot~zoop+flow+sside+chla
# '
#2
# modnorth='chla~corbic+potam+flow
#         tzoop~chla+corbic+potam+flow
#         estfish_bsmt~tzoop+flow+chla
#         estfish_bsot~tzoop+flow
# '
#3
# modnorth='chla~corbic+potam+flow+temp+turbid
#         tzoop~chla+corbic+potam+flow+temp+turbid
#         amphi~chla+corbic+potam+flow+temp+turbid
#         estfish_bsmt~tzoop+amphi+flow+temp+turbid+chla+sside
#         #estfish_bsot~tzoop+amphi+flow+temp+turbid+sside
#         amphi~~tzoop
# '
#4
# modnorth='chla~corbic+flow+temp+turbid
#         hzoop~chla+corbic+flow+temp+turbid
#         pzoop~chla+corbic+flow+temp+turbid+hzoop
#         amphi~chla+corbic+flow+temp+turbid
#         estfish_bsmt~hzoop+pzoop+amphi+flow+temp+turbid+chla+sside
#         amphi~~hzoop+pzoop
# '
#5
modnorth='chla~corbic+flow+temp+turbid
        hzoop~chla+corbic+flow+temp+turbid
        pzoop~chla+corbic+flow+temp+turbid+hzoop
        fish~chla+hzoop+pzoop+corbic+flow+temp+turbid
        fish=~estfish+estfish_stn #+estfish_bsmt
        estfish_stn~~chla
'

modfitnorth=sem(modnorth, data=filter(fdr,region=="North"))
modfitnorth_dtr=sem(modnorth, data=filter(fdr_dtr,region=="North"))
summary(modfitnorth, standardized=T, rsq=T)
summary(modfitnorth_dtr, standardized=T, rsq=T)

labelsnorth <- createLabels(modfitnorth, cnames)

# residuals(modfitnorth)
# modificationindices(modfitnorth)
```

*South*

```{r south}
#1
# modsouth='zoop=~hcope+mysid
#         #fish=~estfish_bsmt+estfish_bsot
#         zoop~chla+corbic+flow
#         chla~corbic+flow
#         estfish_bsmt~zoop+flow
#         estfish_bsot~zoop+flow
# '
#2
# modsouth='chla~corbic+flow
#         tzoop~chla+corbic+flow
#         estfish_bsmt~tzoop+flow+corbic+sside
#         estfish_bsot~tzoop+flow+corbic+sside
# '
#3
# modsouth='chla~corbic+flow+temp+turbid
#         tzoop~chla+corbic+flow+temp+turbid
#         amphi~chla+corbic+flow+temp+turbid
#         estfish_bsmt~tzoop+amphi+flow+temp+turbid+corbic+sside
#         #estfish_bsot~tzoop+amphi+flow+temp+turbid+corbic+sside
#         amphi~~tzoop
# '
#4
# modsouth='chla~corbic+flow+temp+turbid
#         hzoop~chla+corbic+flow+temp+turbid
#         pzoop~chla+corbic+flow+temp+turbid+hzoop
#         amphi~chla+corbic+flow+temp+turbid
#         estfish_bsmt~hzoop+pzoop+amphi+flow+temp+turbid+corbic+sside
#         amphi~~hzoop+pzoop
# '
#5
modsouth='chla~corbic+flow+temp+turbid
        hzoop~chla+corbic+flow+temp+turbid
        pzoop~chla+corbic+flow+temp+turbid+hzoop
        fish~hzoop+pzoop+corbic+flow+temp+turbid
        fish=~estfish+estfish_stn+estfish_bsmt
'
modsouth_dtr='chla~corbic+flow+temp+turbid
        hzoop~chla+corbic+flow+temp+turbid
        pzoop~chla+corbic+flow+temp+turbid+hzoop
        fish~hzoop+pzoop+corbic+flow+temp+turbid
        fish=~estfish #+estfish_stn+estfish_bsmt
'
modfitsouth=sem(modsouth, data=filter(fdr,region=="South"))
modfitsouth_dtr=sem(modsouth_dtr, data=filter(fdr_dtr,region=="South"))
summary(modfitsouth, standardized=T, rsq=T)
summary(modfitsouth_dtr, standardized=T, rsq=T)

labelssouth <- createLabels(modfitsouth, cnames)

# residuals(modfitsouth)
# modificationindices(modfitsouth)
```


### Nice plots 

#### Original units

*West*

```{r, echo=FALSE}
myLavaanPlot(model=modfitwest, labels=labelswest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))

## Updated SEM diagram:
cnames_with_latent <- rbind(cnames,
                            data.frame(Longname="fish", Shortname="fish",
                                       Diagramname="estuarine\nfishes", Datacolumn=NA, Log=NA,
                                       Color="#FF0000"))
figW <- createGraph(fit=modfitwest, 
                    reference_df=cnames_with_latent, 
                    model_type="annual",
                    title="West",
                    manual_port_settings=TRUE)
figW
```

*North*

```{r, echo=FALSE}
myLavaanPlot(model=modfitnorth, labels=labelsnorth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))

figN <- createGraph(fit=modfitnorth, 
                    reference_df=cnames_with_latent, 
                    model_type="annual",
                    title="North",
                    manual_port_settings=TRUE)
figN
```

*South*

```{r, echo=FALSE}
myLavaanPlot(model=modfitsouth, labels=labelssouth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))

figS <- createGraph(fit=modfitsouth, 
                    reference_df=cnames_with_latent, 
                    model_type="annual",
                    title="South",
                    manual_port_settings=TRUE)
figS
```

#### Detrended

*West*

```{r, echo=FALSE}
myLavaanPlot(model=modfitwest_dtr, labels=labelswest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))

createGraph(fit=modfitwest_dtr, 
            reference_df=cnames_with_latent, 
            model_type="annual",
            title="West",
            manual_port_settings=TRUE)
```

*North*

```{r, echo=FALSE}
myLavaanPlot(model=modfitnorth_dtr, labels=labelsnorth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))

createGraph(fit=modfitnorth_dtr, 
            reference_df=cnames_with_latent, 
            model_type="annual",
            title="North",
            manual_port_settings=TRUE)
```

*South*

```{r, echo=FALSE}
myLavaanPlot(model=modfitsouth_dtr, labels=labelssouth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))

createGraph(fit=modfitsouth_dtr, 
            reference_df=cnames_with_latent, 
            model_type="annual",
            title="South",
            manual_port_settings=TRUE)
```

*Save updated SEM diagrams*

```{r}
plot_grobs <- map(list(figW, figN, figS), ~convert_html_to_grob(.x, 2000))
combined_figure <- ggarrange(plotlist=plot_grobs, labels="auto", 
                             font.label=list(size=9)) %>%
  annotate_figure(top = text_grob("Annual SEM (regional)",
                                  color = "black",
                                  face = "bold",
                                  size = 9))# + 
  #theme(plot.margin = unit(c(1,0,0,0), "lines"))

ggsave('./fig_output/sem_annual_regions.png', combined_figure, width=6, height=6,
       dpi=300)
```

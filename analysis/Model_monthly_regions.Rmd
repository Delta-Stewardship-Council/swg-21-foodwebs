---
title: "Monthly model - Regions"
author: "Tanya Rogers"
date: "1/6/2022"
output: html_document
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = '../docs',
      knit_root_dir = '..',
      envir = globalenv()
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, message=FALSE}
library(dplyr)
library(lavaan)
library(DiagrammeR)
library(ggplot2)
library(tidyr)
```

### Import data

```{r import}
combined=read.csv("data/monthly_averages/monthly_data_compiled_regions.csv",stringsAsFactors = F)
cnames=read.csv("analysis/column_names_region_monthly.csv", stringsAsFactors = F)
dsub=filter(combined, Year>=1995) %>% arrange(Region,Year,Month)
focaldata=dsub[,cnames$Datacolumn]
fvars=cnames$Shortname
colnames(focaldata)=fvars
regions=unique(focaldata$region)
regionorder=c("Far West","West","North","South")
focaldata=focaldata%>% 
  mutate(decyear=year+(month-1)/12)

focaldata = focaldata %>% 
  mutate(tzoop=hcope+clad+mysid+pcope+rotif_m,
         tzoop_e=hcope_e+clad_e+mysid_e+pcope_e+rotif_e,
         hzoop=hcope+clad+rotif_m,
         hzoop_e=hcope_e+clad_e+rotif_e,
         pzoop=mysid+pcope,
         pzoop_e=mysid_e+pcope_e) 
fvars=c(fvars,"tzoop","tzoop_e",
        "hzoop","hzoop_e",
        "pzoop","pzoop_e")
cnames=rbind(cnames,data.frame(Longname=NA,Shortname=c("tzoop","tzoop_e",
                                                       "hzoop","hzoop_e",
                                                       "pzoop","pzoop_e"),
                               Diagramname=c("Total Zooplankton\nBiomass",
                                             "Total Zooplankton\nEnergy",
                                             "Herbivorous Zooplankton\nBiomass",
                                             "Herbivorous Zooplankton\nEnergy",
                                             "Predatory Zooplankton\nBiomass",
                                             "Predatory Zooplankton\nEnergy"),
                               Datacolumn=NA,Log="yes"))

#focal variables
varnames=c("temp","flow","secchi","dophos","din","chla","hcope","clad","amphi","pcope","mysid","rotif_m","potam","corbic","sside","cent","marfish_bsmt","estfish_bsmt","tzoop","hzoop","pzoop")

#labels for lagged vars
cnameslag=cnames
cnameslag$Shortname=paste0(cnameslag$Shortname,"_1")
cnameslag$Diagramname=paste(cnameslag$Diagramname,"(t-1)")
cnameslag=rbind(cnames,cnameslag)

source("analysis/myLavaanPlot.r")
```

### Data prep

Log transform, scale.  
Within and across regions.  
Create set with regional monthly means removed.  

```{r prep}
#log transform
logvars=fvars[cnames$Log=="yes"]
logtrans=function(x) {
  x2=x[which(!is.na(x))]
  if(any(x2==0)) {log(x+min(x2[which(x2>0)],na.rm=T))}
  else {log(x)}
}
focaldatalog = focaldata %>% 
  mutate_at(logvars,logtrans)

#scale data
fdr0=focaldatalog
tvars=fvars[-(1:3)]

#scaled within regions
fdr=fdr0 %>% 
  group_by(region) %>% 
  #scale
  mutate_at(tvars,scale) %>% 
  #lag
  mutate_at(tvars,list("1"=lag,"2"=function(x) {lag(x,2)})) %>% 
  ungroup() %>% 
  as.data.frame()

#scaled within regions, remove monthly means
fdr_ds=fdr %>% 
  group_by(region,month) %>%
  mutate_at(tvars,list("mm"=function(x) {mean(x,na.rm = T)})) %>% 
  mutate_at(tvars,function(x) {x-mean(x,na.rm = T)}) %>% 
  ungroup() %>% 
  #lag
  group_by(region) %>% 
  mutate_at(tvars,list("1"=lag,"2"=function(x) {lag(x,2)})) %>% 
  ungroup() %>% 
  as.data.frame()

#scaled across regions
# fdr1=fdr0 %>% 
#   #scale
#   mutate_at(tvars,scale) %>% 
#   #lag
#   group_by(region) %>% 
#   mutate_at(tvars,list("1"=lag,"2"=function(x) {lag(x,2)})) %>% 
#   ungroup() %>% 
#   as.data.frame()

#scaled across regions, monthly means removed
# fdr1_ds=fdr1 %>% 
#   group_by(region,month) %>%
#   mutate_at(tvars,list("mm"=function(x) {mean(x,na.rm = T)})) %>% 
#   mutate_at(tvars,function(x) {x-mean(x,na.rm = T)}) %>% 
#   ungroup() %>% 
#   #lag
#   group_by(region) %>% 
#   mutate_at(tvars,list("1"=lag,"2"=function(x) {lag(x,2)})) %>% 
#   ungroup() %>% 
#   as.data.frame()
```

### Data availability   

Exclude individual zooplankton plankton groups from zooplankton model if rare (95% of values in a region are less than the across site mean, or more than 10% of values in a region are zeros).

sside and cent have no data in FW and W.

marfish and clams excluded if 95% of values in a region are less than the across site mean, though this results in marfish being excluded from W.

FW: exclude clad, mysid, corbic, sside/cent  
W: exclude  clad, corbic, marfish, sside/cent  
N: exclude clad, potam, marfish   
S: exclude mysid, potam, marfish  

```{r avail}
dataavail=focaldata %>% 
  gather(var, value, 4:length(fvars)) %>% 
  group_by(var) %>% 
  mutate(varmean=mean(value, na.rm=T)) %>% ungroup() %>% 
  group_by(region, var) %>% 
  summarize(
    propmissing=length(which(is.na(value)))/length(value),
    propzeros=length(which(value==0))/length(which(!is.na(value))),
    exclude=ifelse(quantile(value,probs = 0.95, na.rm = T)<mean(varmean),T,F)) %>% 
  as.data.frame()

#these variables should not be used (too many zeros)
filter(dataavail,propzeros>0.1 | exclude) %>% filter(var %in% c("mysid","hcope","pcope","rotif_m","clad"))
filter(dataavail,exclude) %>% filter(var %in% c("marfish_bsmt","potam","corbic"))
```

### Time series plots

```{r timeseries, fig.width=8, fig.height=13, echo=FALSE, warning=FALSE}
plot1=select(focaldata,region,decyear,varnames) %>% 
  gather(Var,Value,varnames) %>% 
  mutate(Var=factor(Var,levels = varnames),region=factor(region,levels=regionorder))
ggplot(plot1,aes(x=decyear,y=Value)) +
  facet_grid(Var~region, scales="free_y") +
  geom_line() +
  theme_bw() +
  labs(title = "Original Units")

plot2=select(fdr,region,decyear,varnames) %>% 
  gather(Var,Value,varnames) %>% 
  mutate(Var=factor(Var,levels = varnames),region=factor(region,levels=regionorder))
ggplot(plot2,aes(x=decyear,y=Value)) +
  facet_grid(Var~region, scales="free_y") +
  geom_line() +
  theme_bw() +
  labs(title = "Log scaled")

plot3=select(fdr_ds,region,decyear,varnames) %>% 
  gather(Var,Value,varnames) %>% 
  mutate(Var=factor(Var,levels = varnames),
         region=factor(region,levels=regionorder))
plotmm=select(fdr_ds,region,decyear,paste0(varnames,"_mm")) %>% 
  gather(Var,Value,paste0(varnames,"_mm")) %>% 
  mutate(Var=gsub("_mm","",Var)) %>% 
  mutate(Var=factor(Var,levels = varnames),
         region=factor(region,levels=regionorder))
ggplot(plot3,aes(x=decyear,y=Value)) +
  facet_grid(Var~region, scales="free_y") +
  geom_line(data=plotmm,color="tomato") +
  geom_line() +
  theme_bw() +
  labs(title = "Seasonal means removed")
```

### Other useful plots

Breakdown of total zooplankton biomass.

```{r zoops, echo=FALSE}
plot4=select(focaldata,region,decyear,hcope,pcope,clad,mysid,rotif_m) %>% 
  gather(Var,Value,hcope:rotif_m) %>% 
  mutate(region=factor(region,levels=regionorder))
ggplot(plot4,aes(x=decyear,y=Value,fill=Var)) +
  facet_grid(region~., scales="free_y") +
  geom_area() +
  theme_bw() + scale_fill_brewer(palette = "Dark2") +
  labs(title = "Original units")
```

Correlation between biomass and energy.

```{r}
for(i in 1:length(regions)) {
  dtemp=filter(fdr,region==regions[i])
  print(regions[i])
  print(cor(dtemp$tzoop,dtemp$tzoop_e,use = "p"))
  print(cor(dtemp$hzoop,dtemp$hzoop_e,use = "p"))
  print(cor(dtemp$pzoop,dtemp$pzoop_e,use = "p"))
}
```

### Cross-correlation matrices  
(only sig correlations shown... no correction for multiple comparisons)

```{r cc, fig.width=7, fig.height=6, echo=FALSE}
#lag 0
lags0=expand.grid(region=regions,V1=varnames,V2=varnames,Cor=NA,P=NA,
                  stringsAsFactors = F)
for(i in 1:nrow(lags0)) {
  v1=fdr[fdr$region==lags0$region[i],lags0$V1[i]]
  v2=fdr[fdr$region==lags0$region[i],lags0$V2[i]]
  if(!all(is.na(v1)) & !all(is.na(v2))) {
    tccf=cor.test(v1,v2)
    lags0$Cor[i]=tccf$estimate
    lags0$P[i]=tccf$p.value
  }
}
lags0$V1=factor(lags0$V1,levels = varnames)
lags0$V2=factor(lags0$V2,levels = varnames)
lags0$region=factor(lags0$region,levels = regionorder)
ggplot(filter(lags0,P<0.05,V1!=V2), aes(x=V2,y=V1,fill=Cor)) +
  facet_wrap(.~region, nrow=2, scales = "free", drop=F, strip.position = "right",dir = "v") +
  geom_tile() +
  geom_abline(slope=1,intercept = 0) +
  scale_fill_gradient2() +
  theme_bw() +
  labs(x="V2 (t)", y="V1 (t)", title = "lag 0 cross-cor") +
  scale_x_discrete(expand = expand_scale(mult = 0),drop=F) +
  scale_y_discrete(expand = expand_scale(mult = 0),drop=F) +
  theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1))

#lag 1
lags1=expand.grid(region=regions,V1=varnames,V2=varnames,Cor=NA,P=NA,
                  stringsAsFactors = F)
for(i in 1:nrow(lags1)) {
  v1=fdr[fdr$region==lags1$region[i],lags1$V1[i]]
  v2=fdr[fdr$region==lags1$region[i],lags1$V2[i]]
  if(!all(is.na(v1)) & !all(is.na(v2))) {
    tccf=cor.test(v1,lag(v2,1))
    lags1$Cor[i]=tccf$estimate
    lags1$P[i]=tccf$p.value
  }
}
lags1$V1=factor(lags1$V1,levels = varnames)
lags1$V2=factor(lags1$V2,levels = varnames)
lags1$region=factor(lags1$region,levels = regionorder)
ggplot(filter(lags1,P<0.05), aes(x=V2,y=V1,fill=Cor)) +
  facet_wrap(.~region, nrow=2, scales = "free", drop=F, strip.position = "right",dir = "v") +
  geom_tile() +
  geom_abline(slope=1,intercept = 0) +
  scale_fill_gradient2() +
  theme_bw() +
  labs(x="V2 (t-1)", y="V1 (t)", title = "lag 1 cross-cor") +
  scale_x_discrete(expand = expand_scale(mult = 0),drop=F) +
  scale_y_discrete(expand = expand_scale(mult = 0),drop=F) +
  theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1))

#lag 1 seasonality removed
lags1ds=expand.grid(region=regions,V1=varnames,V2=varnames,Cor=NA,P=NA,
                  stringsAsFactors = F)
for(i in 1:nrow(lags1ds)) {
  v1=fdr_ds[fdr_ds$region==lags1ds$region[i],lags1ds$V1[i]]
  v2=fdr_ds[fdr_ds$region==lags1ds$region[i],lags1ds$V2[i]]
  if(!all(is.na(v1)) & !all(is.na(v2))) {
    tccf=cor.test(v1,lag(v2,1))
    lags1ds$Cor[i]=tccf$estimate
    lags1ds$P[i]=tccf$p.value
  }
}
lags1ds$V1=factor(lags1ds$V1,levels = varnames)
lags1ds$V2=factor(lags1ds$V2,levels = varnames)
lags1ds$region=factor(lags1ds$region,levels = regionorder)
ggplot(filter(lags1ds,P<0.05), aes(x=V2,y=V1,fill=Cor)) +
  facet_wrap(.~region, nrow=2, scales = "free", drop=F, strip.position = "right",dir = "v") +
  geom_tile() +
  geom_abline(slope=1,intercept = 0) +
  scale_fill_gradient2() +
  theme_bw() +
  labs(x="V2 (t-1)", y="V1 (t)",title = "lag 1 cross-cor, monthly means removed") +
  scale_x_discrete(expand = expand_scale(mult = 0),drop=F) +
  scale_y_discrete(expand = expand_scale(mult = 0),drop=F) +
  theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1))
```

Other notes:

*Detrended fish indices are NOT correlated in S!*  

Nitrate and ammonia are positively correlated, max at lag 0 all regions.  
Nitrate and dophos are positively correlated, max at lag 0 all regions.  
Ammonia and dophos are positively correlated, lag 0 for FW and S, ammonia lags dphos by 3 months in W and N.  

Chla nitrate neg correlated, lag 0.  
Chla ammonia neg correlated, lag 0.  
Chla dophos relationship unclear.  

High flow 2-4 month prev = high chla

Hcope lags chla by 1, positive, except FW.  
Clad seem to precede chla by 2, positive.  
Amphi relationship unclear, prob bc not eating chla in water column.  
In N and W, chla lags potam, negative. The opposite in W.  

Mysid and hcope postive, lag 0.  
In S and W, hcope lags pcope, negative. 

### Exploratory plots

```{r other, echo=FALSE, eval=FALSE}
#ccf between two variables for all regions
ccfplot=function(v1,v2) {
  par(mfrow=c(2,2),mar=c(3,3,1.5,1))
  for(i in 1:length(regions)) {
    dtemp=filter(fdr_ds,region==regions[i])
    ccf(dtemp[,v1], dtemp[,v2],lag.max = 6, na.action = na.pass)
    title(paste(regions[i],v1,v2), line=0.5)
  }
}

ccfplot("chla","din")
ccfplot("chla","hzoop")
ccfplot("hzoop","pzoop")
ccfplot("chla","potam")
ccfplot("hzoop","estfish_bsmt")
ccfplot("pzoop","estfish_bsmt")
ccfplot("estfish_bsmt","secchi")


#plot multiple variables on top of each other
ggplot(fdr,aes(x=decyear)) + 
  facet_grid(region~.) + 
  geom_line(aes(y=ammonia)) +
  geom_line(aes(y=chla),color="green") +
  geom_line(aes(y=hcope),color="blue")

#plot a single variable
ggplot(fdr,aes(x=decyear, y=flow, color=region)) + geom_line()

#individual bivariate plots
ggplot(focaldata,aes(x=ammonia, y=chla)) + 
  facet_grid(region~.) + geom_point()
ggplot(fdr,aes(x=ammonia_1, y=chla)) + 
  facet_grid(region~.) + geom_point()
ggplot(fdr,aes(x=ammonia, y=dophos, color=chla)) + 
  facet_grid(region~.) + geom_point() + 
  scale_color_viridis_c()
```

### Fish-centered model (upper trophic level aggregates)

```{r, fig.width=8, fig.height=8}
modFW='hzoop~hb1*chla_1+hs1*hzoop_1+ht1*pzoop_1+ht2*potam_1+ht3*estfish_bsmt_1+ha1*flow+ha2*temp+ha3*secchi
        pzoop~pb1*hzoop_1+ps1*pzoop_1+pt1*potam_1+pt2*estfish_bsmt_1+pa1*flow+pa2*temp+pa3*secchi
        estfish_bsmt~fb1*hzoop_1+fb2*pzoop_1+fs1*estfish_bsmt_1+fa1*flow+fa2*temp+fa3*secchi+ft1*marfish_bsmt_1
        
        hb:=hb1
        hs:=hs1
        ht:=ht1+ht2+ht3
        ha:=ha1-ha2-ha3
        
        pb:=pb1
        ps:=ps1
        pt:=pt1+pt2
        pa:=pa1-pa2-pa3
        
        fb:=fb1+fb2
        fs:=fs1
        ft:=ft1
        fa:=fa1-fa2-fa3
'

modW='hzoop~hb1*chla_1+hs1*hzoop_1+ht1*pzoop_1+ht2*potam_1+ht3*estfish_bsmt_1+ha1*flow+ha2*temp+ha3*secchi
        pzoop~pb1*chla_1+pb2*hzoop_1+ps1*pzoop_1+pt1*potam_1+pt2*estfish_bsmt_1+pa1*flow+pa2*temp+pa3*secchi
        estfish_bsmt~fb1*hzoop_1+fb2*pzoop_1+fs1*estfish_bsmt_1+fa1*flow+fa2*temp+fa3*secchi
        
        hb:=hb1
        hs:=hs1
        ht:=ht1+ht2+ht3
        ha:=ha1-ha2-ha3
        
        pb:=pb1+pb2
        ps:=ps1
        pt:=pt1+pt2
        pa:=pa1-pa2-pa3
        
        fb:=fb1+fb2
        fs:=fs1
        fa:=fa1-fa2-fa3
'

modN='hzoop~hb1*chla_1+hs1*hzoop_1+ht1*pzoop_1+ht2*corbic_1+ht3*estfish_bsmt_1+ha1*flow+ha2*temp+ha3*secchi
        pzoop~pb1*chla_1+pb2*hzoop_1+ps1*pzoop_1+pt1*corbic_1+pt2*estfish_bsmt_1+pa1*flow+pa2*temp+pa3*secchi
        estfish_bsmt~fb1*hzoop_1+fb2*pzoop_1+fs1*estfish_bsmt_1+fa1*flow+fa2*temp+fa3*secchi+ft1*sside_1+ft2*cent_1
        
        hb:=hb1
        hs:=hs1
        ht:=ht1+ht2+ht3
        ha:=ha1-ha2-ha3
        
        pb:=pb1+pb2
        ps:=ps1
        pt:=pt1+pt2
        pa:=pa1-pa2-pa3
        
        fb:=fb1+fb2
        fs:=fs1
        ft:=ft1+ft2
        fa:=fa1-fa2-fa3
'

modS='hzoop~hb1*chla_1+hs1*hzoop_1+ht1*pzoop_1+ht2*corbic_1+ht3*estfish_bsmt_1+ha1*flow+ha2*temp+ha3*secchi
        pzoop~pb1*chla_1+pb2*hzoop_1+ps1*pzoop_1+pt1*corbic_1+pt2*estfish_bsmt_1+pa1*flow+pa2*temp+pa3*secchi
        estfish_bsmt~fb1*chla_1+fb2*hzoop_1+fb3*pzoop_1+fs1*estfish_bsmt_1+fa1*flow+fa2*temp+fa3*secchi+ft1*sside_1+ft2*cent_1
        
        hb:=hb1
        hs:=hs1
        ht:=ht1+ht2+ht3
        ha:=ha1-ha2-ha3
        
        pb:=pb1+pb2
        ps:=ps1
        pt:=pt1+pt2
        pa:=pa1-pa2-pa3
        
        fb:=fb1+fb2+fb3
        fs:=fs1
        ft:=ft1+ft2
        fa:=fa1-fa2-fa3
'

modfitFW=sem(modFW, data=filter(fdr_ds,region=="Far West"))
modfitW=sem(modW, data=filter(fdr_ds,region=="West"))
modfitN=sem(modN, data=filter(fdr_ds,region=="North"))
modfitS=sem(modS, data=filter(fdr_ds,region=="South"))
summary(modfitFW, standardized=T, rsq=T)
summary(modfitW, standardized=T, rsq=T)
summary(modfitN, standardized=T, rsq=T)
summary(modfitS, standardized=T, rsq=T)

#modificationindices(modfitW, sort=T, maximum.number=20)
#residuals(modfitS)

labelsfarwest=createLabels(modfitFW, cnameslag)
labelswest=createLabels(modfitW, cnameslag)
labelsnorth=createLabels(modfitN, cnameslag)
labelssouth=createLabels(modfitS, cnameslag)

#FAR WEST
myLavaanPlot(model=modfitFW, labels=labelsfarwest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
#WEST
myLavaanPlot(model=modfitW, labels=labelswest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
#NORTH
myLavaanPlot(model=modfitN, labels=labelsnorth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
#SOUTH
myLavaanPlot(model=modfitS, labels=labelssouth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

Total effects

Abiotic:  
positive values = promoted by high flow, low temp, low secchi/high turbidity  
negative values = promoted by low flow, high temp, high secchi/low turbidity  

```{r}
ssFW=standardizedsolution(modfitFW) %>% mutate(region="Far West")
ssW=standardizedsolution(modfitW) %>% mutate(region="West")
ssN=standardizedsolution(modfitN) %>% mutate(region="North")
ssS=standardizedsolution(modfitS) %>% mutate(region="South")

ssut=rbind(ssFW,ssW,ssN,ssS) %>% filter(op==":=") %>% select(region,lhs,est.std:ci.upper) %>% 
  separate(lhs,c("variable","influence"), sep=1) %>% 
  mutate(variable=case_when(variable=="h" ~ "herbivorous\nzooplankton",
                            variable=="p" ~ "predatory\nzooplankton",
                            variable=="f" ~ "estuarine\nfishes"),
         influence=case_when(influence=="b" ~ "bottom-up",
                            influence=="t" ~ "top-down",
                            influence=="s" ~ "self-regulation",
                            influence=="a" ~ "abiotic drivers"),
         region=factor(region, levels=regionorder),
         influence=factor(influence, levels=c("self-regulation","bottom-up","top-down","abiotic drivers")),
         variable=factor(variable,levels=c("estuarine\nfishes","predatory\nzooplankton","herbivorous\nzooplankton")),
         sig=ifelse(pvalue<0.05,"*",""))

ggplot(ssut,aes(x=influence,y=est.std)) +
  facet_grid(variable~region) +
  geom_errorbar(aes(ymin=ci.lower, ymax=ci.upper),width=0.5) +
  geom_point() +
  geom_text(aes(y=ci.upper+0.05, label=sig)) +
  geom_hline(yintercept = 0) +
  theme_bw() + theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1)) +
  labs(y="total effect (standardized)")
#ggsave("../uteffects.png",width = 6,height=5)
```

### Phytoplankton-centered model (lower trophic level aggregates)

```{r, fig.width=8, fig.height=8}
modFW='din~ns1*din_1+nt1*chla_1+nn1*hzoop_1+nn2*pzoop_1+nn3*potam_1+na1*flow+na2*temp+na3*secchi
        chla~cb1*din+cs1*chla_1+ct1*hzoop_1+ct2*potam_1+ca1*flow+ca2*temp+ca3*secchi
        potam~lb1*chla_1+lb2*hzoop_1+lb3*pzoop_1+ls1*potam_1+la1*flow+la2*temp+la3*secchi
        
        ns:=ns1
        nt:=nt1
        nn:=nn1+nn2+nn3
        na:=na1-na2-na3
        
        cb:=cb1
        cs:=cs1
        ct:=ct1+ct2
        ca:=ca1-ca2-ca3
        
        lb:=lb1+lb2+lb3
        ls:=ls1
        la:=la1-la2-la3
'

modW='din~ns1*din_1+nt1*chla_1+nn1*hzoop_1+nn2*pzoop_1+nn3*potam_1+na1*flow+na2*temp+na3*secchi
        chla~cb1*din+cs1*chla_1+ct1*hzoop_1+ct2*potam_1+ca1*flow+ca2*temp+ca3*secchi
        potam~lb1*din_1+lb2*chla_1+lb3*hzoop_1+lb4*pzoop_1+ls1*potam_1+la1*flow+la2*temp+la3*secchi
        
        ns:=ns1
        nt:=nt1
        nn:=nn1+nn2+nn3
        na:=na1-na2-na3
        
        cb:=cb1
        cs:=cs1
        ct:=ct1+ct2
        ca:=ca1-ca2-ca3
        
        lb:=lb1+lb2+lb3+lb4
        ls:=ls1
        la:=la1-la2-la3'

modN='din~ns1*din_1+nt1*chla_1+nn1*hzoop_1+nn2*pzoop_1+nn3*corbic_1+na1*flow+na2*temp+na3*secchi
        chla~cb1*din+cs1*chla_1+ct1*hzoop_1+ct2*corbic_1+ca1*flow+ca2*temp+ca3*secchi
        corbic~lb1*chla_1+lb2*hzoop_1+lb3*pzoop_1+ls1*corbic_1+la1*flow+la2*temp+la3*secchi
        
        ns:=ns1
        nt:=nt1
        nn:=nn1+nn2+nn3
        na:=na1-na2-na3
        
        cb:=cb1
        cs:=cs1
        ct:=ct1+ct2
        ca:=ca1-ca2-ca3
        
        lb:=lb1+lb2+lb3
        ls:=ls1
        la:=la1-la2-la3'

modS='din~ns1*din_1+nt1*chla_1+nn1*hzoop_1+nn2*pzoop_1+nn3*corbic_1+na1*flow+na2*temp+na3*secchi
        chla~cb1*din+cs1*chla_1+ct1*hzoop_1+ct2*corbic_1+ca1*flow+ca2*temp+ca3*secchi
        corbic~lb1*chla_1+lb2*hzoop_1+lb3*pzoop_1+ls1*corbic_1+la1*flow+la2*temp+la3*secchi
        
        ns:=ns1
        nt:=nt1
        nn:=nn1+nn2+nn3
        na:=na1-na2-na3
        
        cb:=cb1
        cs:=cs1
        ct:=ct1+ct2
        ca:=ca1-ca2-ca3
        
        lb:=lb1+lb2+lb3
        ls:=ls1
        la:=la1-la2-la3'

modfitFW=sem(modFW, data=filter(fdr_ds,region=="Far West"))
modfitW=sem(modW, data=filter(fdr_ds,region=="West"))
modfitN=sem(modN, data=filter(fdr_ds,region=="North"))
modfitS=sem(modS, data=filter(fdr_ds,region=="South"))
summary(modfitFW, standardized=T, rsq=T)
summary(modfitW, standardized=T, rsq=T)
summary(modfitN, standardized=T, rsq=T)
summary(modfitS, standardized=T, rsq=T)

#modificationindices(modfitW, sort=T, maximum.number=20)
#residuals(modfitW)

labelsfarwest=createLabels(modfitFW, cnameslag)
labelswest=createLabels(modfitW, cnameslag)
labelsnorth=createLabels(modfitN, cnameslag)
labelssouth=createLabels(modfitS, cnameslag)

#FAR WEST
myLavaanPlot(model=modfitFW, labels=labelsfarwest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
#WEST
myLavaanPlot(model=modfitW, labels=labelswest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
#NORTH
myLavaanPlot(model=modfitN, labels=labelsnorth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
#SOUTH
myLavaanPlot(model=modfitS, labels=labelssouth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

Total effects

Abiotic:  
positive values = promoted by high flow, low temp, low secchi/high turbidity  
negative values = promoted by low flow, high temp, high secchi/low turbidity  

```{r}
ssFW=standardizedsolution(modfitFW) %>% mutate(region="Far West")
ssW=standardizedsolution(modfitW) %>% mutate(region="West")
ssN=standardizedsolution(modfitN) %>% mutate(region="North")
ssS=standardizedsolution(modfitS) %>% mutate(region="South")

sslt=rbind(ssFW,ssW,ssN,ssS) %>% filter(op==":=") %>% select(region,lhs,est.std:ci.upper) %>% 
  separate(lhs,c("variable","influence"), sep=1) %>% 
  mutate(variable=case_when(variable=="n" ~ "DIN",
                            variable=="c" ~ "phytoplankton",
                            variable=="l" ~ "clams"),
         influence=case_when(influence=="b" ~ "bottom-up",
                            influence=="t" ~ "top-down",
                            influence=="s" ~ "self-regulation",
                            influence=="a" ~ "abiotic drivers",
                            influence=="n" ~ "nutrient cycling"),
         region=factor(region, levels=regionorder),
         influence=factor(influence, levels=c("self-regulation","bottom-up","top-down","abiotic drivers","nutrient cycling")),
         variable=factor(variable,levels=c("clams","phytoplankton","DIN")),
         sig=ifelse(pvalue<0.05,"*",""))

ggplot(sslt,aes(x=influence,y=est.std)) +
  facet_grid(variable~region) +
  geom_errorbar(aes(ymin=ci.lower, ymax=ci.upper),width=0.5) +
  geom_point() +
  geom_text(aes(y=ci.upper+0.05, label=sig)) +
  geom_hline(yintercept = 0) +
  theme_bw() + theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1)) +
  labs(y="total effect (standardized)")
#ggsave("../lteffects.png",width = 6,height=5)
```

### Zooplankton-centered model (individual groups)

```{r, fig.width=8, fig.height=8}
modFW='chla~chla_1+hcope_1+amphi_1+potam_1+flow+secchi+temp
       hcope~chla_1+hcope_1+pcope_1+potam_1+flow+secchi+temp+estfish_bsmt_1
       amphi~chla_1+amphi_1+flow+secchi+temp+estfish_bsmt_1
       pcope~hcope_1+pcope_1+potam_1+flow+secchi+temp+estfish_bsmt_1
'
modW='chla~chla_1+hcope_1+amphi_1+potam_1+flow+secchi+temp+mysid_1
       hcope~chla_1+hcope_1+pcope_1+mysid_1+potam_1+flow+secchi+temp+estfish_bsmt_1
       amphi~chla_1+amphi_1+mysid_1+flow+secchi+temp+estfish_bsmt_1
       pcope~hcope_1+pcope_1+mysid_1+potam_1+flow+secchi+temp+estfish_bsmt_1
       mysid~chla_1+hcope_1+pcope_1+amphi_1+mysid_1+flow+secchi+temp+estfish_bsmt_1
'
modN='chla~chla_1+hcope_1+amphi_1+corbic_1+flow+secchi+temp
       hcope~chla_1+hcope_1+pcope_1+mysid_1+corbic_1+flow+secchi+temp+estfish_bsmt_1
       amphi~chla_1+amphi_1+flow+secchi+temp+estfish_bsmt_1
       pcope~hcope_1+pcope_1+mysid_1+corbic_1+flow+secchi+temp+estfish_bsmt_1
       mysid~hcope_1+pcope_1+mysid_1+amphi_1+flow+secchi+temp+estfish_bsmt_1
'
modS='chla~chla_1+hcope_1+clad_1+corbic_1+flow+secchi+temp
       hcope~chla_1+hcope_1+pcope_1+corbic_1+flow+secchi+temp+estfish_bsmt_1
       clad~chla_1+clad_1+pcope_1+flow+secchi+temp+estfish_bsmt_1
       amphi~chla_1+amphi_1+flow+secchi+temp+estfish_bsmt_1
       pcope~chla_1+hcope_1+clad_1+pcope_1+corbic_1+flow+secchi+temp+estfish_bsmt_1
'
modfitFW=sem(modFW, data=filter(fdr_ds,region=="Far West"))
modfitW=sem(modW, data=filter(fdr_ds,region=="West"))
modfitN=sem(modN, data=filter(fdr_ds,region=="North"))
modfitS=sem(modS, data=filter(fdr_ds,region=="South"))
summary(modfitFW, standardized=T, rsq=T)
summary(modfitW, standardized=T, rsq=T)
summary(modfitN, standardized=T, rsq=T)
summary(modfitS, standardized=T, rsq=T)

#modificationindices(modfitS, sort=T, maximum.number=20)
#residuals(modfitW)

labelsfarwest=createLabels(modfitFW, cnameslag)
labelswest=createLabels(modfitW, cnameslag)
labelsnorth=createLabels(modfitN, cnameslag)
labelssouth=createLabels(modfitS, cnameslag)

#FAR WEST
myLavaanPlot(model=modfitFW, labels=labelsfarwest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
#WEST
myLavaanPlot(model=modfitW, labels=labelswest,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
#NORTH
myLavaanPlot(model=modfitN, labels=labelsnorth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
#SOUTH
myLavaanPlot(model=modfitS, labels=labelssouth,
						 node_options=list(shape="box", fontname="Helvetica"), 
						 coefs=TRUE, stand=TRUE, covs=FALSE, sig=0.05, 
						 width=c("regress","latent"),
						 color=c("regress","latent"))
```

Total effects

Haven't done yet.
